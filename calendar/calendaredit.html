<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>ICS æ—¥å†äº‹ä»¶ç”Ÿæˆå™¨ - 0515364.xyz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            --primary: #2563eb;
            --generate: #2980b9;
            --copy: #27ae60;
            --download: #e67e22;
            --add-day: #8e44ad;
            --secondary: #6b7280;
            --success: #10b981;
            --error: #ef4444;
            --light-bg: #f6f7fb;
            --white: #fff;
            --border: #e2e6ef;
            --text-main: #111;
            --text-muted: #6b7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--light-bg);
            color: var(--text-main);
            min-height: 100vh;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 0;
            gap: 2px;
            overflow-x: auto;
            padding-bottom: 2px;
        }

        .tab-btn {
            padding: 8px 12px;
            border: none;
            background: var(--light-bg);
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px 8px 0 0;
            font-size: 0.9rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .tab-btn.active {
            background: var(--white);
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .tab-content {
            display: none;
            background: var(--white);
            border-radius: 0 0 10px 10px;
            padding: 15px;
            box-shadow: 0 1px 6px rgba(20, 20, 40, 0.06);
            margin-bottom: 12px;
        }

        .tab-content.active {
            display: block;
        }

        h1,
        h2,
        h3 {
            margin-bottom: 12px;
            font-weight: 600;
        }

        h1 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        h2 {
            font-size: 1.1rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        h3 {
            font-size: 1rem;
            margin-top: 15px;
            color: var(--text-main);
        }

        .card {
            background: var(--white);
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 1px 6px rgba(20, 20, 40, 0.06);
            margin-bottom: 12px;
        }

        label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 4px;
            color: var(--primary);
            font-weight: 600;
            align-items: center;
            gap: 6px;
            display: flex;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .date-row,
        .time-row {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
            margin-bottom: 8px;
        }

        .date-row>div,
        .time-row>div {
            flex: 1;
            min-width: 0;
        }

        .festival-select {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 8px 0;
        }

        .festival-select label {
            flex: 1;
            min-width: 45%;
            margin-bottom: 0;
        }

        button {
            padding: 7px 12px;
            border: 0;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        button.primary {
            background: var(--primary);
            color: var(--white);
        }

        button.generate-btn {
            background: var(--generate);
            color: var(--white);
        }

        button.copy-btn {
            background: var(--copy);
            color: var(--white);
        }

        button.download-btn {
            background: var(--download);
            color: var(--white);
        }

        button.add-day-btn {
            background: var(--add-day);
            color: var(--white);
        }

        button.secondary {
            background: var(--secondary);
            color: var(--white);
        }

        button.small {
            padding: 5px 8px;
            font-size: 0.8rem;
        }

        .event-header-actions {
            display: flex;
            gap: 5px;
        }

        button:hover {
            opacity: 0.9;
            transform: none;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 8px 0;
        }

        .events-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 8px 0;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 8px;
        }

        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            gap: 8px;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-name {
            font-size: 0.85rem;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .preview,
        #dayJson {
            white-space: pre;
            overflow: auto;
            max-height: 370px;
            min-height: 370px;
            padding: 10px;
            background: #0b1220;
            color: #e6eef8;
            font-family: monospace;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        #output {
            min-height: 400px;
            max-height: 400px;
            font-size: 0.85rem;
        }

        .muted,
        #count {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin: 6px 0;
            line-height: 1.4;
        }

        /* é€‰é¡¹äºŒæ§ä»¶å¸ƒå±€ä¼˜åŒ– */
        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 8px;
            align-items: center;
        }

        .controls>div {
            flex: 1;
            min-width: 180px;
        }

        .uid-status {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: -4px;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }

        .uid-status.auto {
            color: var(--success);
        }

        .uid-status.manual {
            color: #f59e0b;
        }

        .desc-status {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: -4px;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }

        .desc-status.auto {
            color: var(--success);
        }

        .desc-status.manual {
            color: #f59e0b;
        }

        .rruleCustom {
            width: 100% !important;
            height: 38px;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow-x: auto;
            font-family: system-ui, -apple-system, sans-serif;
            margin-bottom: 8px;
        }

        /* å†œå†JSONå®¹å™¨ */
        #dayJsonContainer {
            background: var(--white);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        #dayJsonToggle {
            cursor: pointer;
            color: var(--generate);
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-block;
            margin-bottom: 6px;
        }

        .notification,
        #notify {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--white);
            border-radius: 6px;
            padding: 10px 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 10000;
            max-width: 280px;
            transition: all 0.3s ease;
        }

        .notification {
            transform: translateX(100%);
            opacity: 0;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        #notify {
            top: -50px;
        }

        .notification.success,
        #notify.success {
            border-left: 4px solid var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .notification.error,
        #notify.error {
            border-left: 4px solid var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .notification-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 0.85rem;
        }

        .notification-message {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* å¼¹çª—ä¼˜åŒ–ï¼šæ‰‹æœºç«¯é€‚é… */
        .dialog-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 15px;
        }

        .dialog-box {
            background: var(--white);
            border-radius: 8px;
            padding: 15px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
        }

        .dialog-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" data-tab="tab1"><i class="fa-solid fa-calendar-plus"></i> ICS äº‹ä»¶ç”Ÿæˆå™¨</button>
            <button class="tab-btn" data-tab="tab2"><i class="fa-solid fa-calendar-days"></i> æ•´å¹´èŠ‚æ—¥ ICS ç”Ÿæˆå™¨</button>
        </div>
        <!-- é€‰é¡¹ä¸€å†…å®¹ -->
        <div class="tab-content active" id="tab1">
            <h1>
                <i class="fa-solid fa-calendar-plus"></i> ICS äº‹ä»¶ç”Ÿæˆå™¨ <a href="../calendar/"
                    style="margin-left: auto; font-size: 0.85rem; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 4px;">
                    <i class="fa-solid fa-calendar-days"></i> è®¢é˜…æ—¥å† </a>
            </h1>
            <div class="card">
                <label><i class="fa-solid fa-book"></i> æ—¥å†åç§°ï¼ˆX-WR-CALNAMEï¼‰</label>
                <input id="calName" type="text" value="æˆ‘çš„æ—¥å†" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„æ—¥å†">
                <label style="align-items: flex-start;">
                    <i class="fa-solid fa-globe"></i> æ—¶åŒº (X-WR-TIMEZONE) <button id="refreshTz" class="small secondary"
                        style="margin-left: auto; background: var(--error);">
                        <i class="fa-solid fa-rotate"></i> é‡ç½® </button>
                </label>
                <input id="tz" type="text" placeholder="ä¾‹å¦‚ï¼šAsia/Shanghai">
                <label><i class="fa-solid fa-code"></i> PRODID</label>
                <input id="prodid" type="text" value="-//0515364.xyz//My Calendar//CN">
            </div>
            <div class="card">
                <strong style="display: flex; align-items: center; gap: 6px;"><i class="fa-solid fa-list"></i>
                    äº‹ä»¶åˆ—è¡¨</strong>
                <div id="events" class="events-list" style="margin-top: 8px;">
                </div>
                <div class="btn-group">
                    <button id="addEventBtn" class="small primary"><i class="fa-solid fa-plus"></i> æ·»åŠ äº‹ä»¶</button>
                    <button id="clearEvents" class="small secondary"><i class="fa-solid fa-trash"></i> æ¸…ç©ºæ‰€æœ‰</button>
                </div>
                <div class="muted">
                    <i class="fa-solid fa-circle-info"></i> è¯´æ˜ï¼š<br>
                    â€¢ UID å¯ç•™ç©ºï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆæ‹¼éŸ³æ ¼å¼çš„UIDï¼›<br>
                    â€¢ DTSTAMP è‡ªåŠ¨å¡«å†™ä¸ºå½“å‰æœ¬åœ°æ—¶é—´ï¼›<br>
                    â€¢ é»˜è®¤å…¨å¤©äº‹ä»¶ï¼Œå¯å‹¾é€‰"æ·»åŠ æ—¶é—´"è®¾ç½®å…·ä½“æ—¶æ®µï¼›<br>
                    â€¢ ä¿®æ”¹é‡å¤è§„åˆ™è¯·æŸ¥çœ‹"è§„åˆ™ä»‹ç»"ã€‚
                </div>
            </div>
            <!-- æ“ä½œæŒ‰é’®ç»„ -->
            <div class="btn-group">
                <button id="generateBtn" class="primary"><i class="fa-solid fa-eye"></i> ç”Ÿæˆ .ics å¹¶é¢„è§ˆ</button>
                <button id="copyBtnTab1" class="copy-btn"><i class="fa-solid fa-copy"></i> å¤åˆ¶</button>
                <button id="downloadBtnTab1" class="download-btn"><i class="fa-solid fa-download"></i> ä¸‹è½½</button>
            </div>
            <div class="card">
                <label><i class="fa-solid fa-code"></i> é¢„è§ˆ (.ics)</label>
                <div id="preview" class="preview">// ç‚¹å‡»"ç”Ÿæˆ .ics å¹¶é¢„è§ˆ"æŸ¥çœ‹ç»“æœ
                </div>
            </div>
        </div>
        <!-- é€‰é¡¹äºŒå†…å®¹ -->
        <div class="tab-content" id="tab2">
            <h2><i class="fa-solid fa-calendar-days"></i> æ•´å¹´ ICS ç”Ÿæˆå™¨ <a href="../calendar/"
                    style="margin-left: auto; font-size: 0.85rem; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 4px;">
                    <i class="fa-solid fa-calendar-days"></i> è®¢é˜…æ—¥å† </a>
            </h2>
            <div class="controls">
                <label>
                    <i class="fa-solid fa-hashtag"></i> å¹´ä»½: <input type="number" id="year" min="1900" max="2100"
                        style="width: 80px; margin-left: 8px; margin-top: 5px;" placeholder="2024">
                </label>
                <script>
                    const yearInput = document.getElementById('year');
                    yearInput.addEventListener('input', function () {
                        if (this.value.length > 4) {
                            this.value = this.value.slice(0, 4);
                        }
                    });
                </script>
            </div>
            <div class="festival-select">
                <label><input type="checkbox" id="chkSolar" checked><i class="fa-solid fa-star"></i> é˜³å†èŠ‚æ—¥</label>
                <label><input type="checkbox" id="chkLunar" checked><i class="fa-solid fa-moon"></i> å†œå†èŠ‚æ—¥</label>
                <label><input type="checkbox" id="chkOther"><i class="fa-solid fa-heart"></i> å…¶ä»–çºªå¿µæ—¥</label>
                <label><input type="checkbox" id="chkTerm" checked><i class="fa-solid fa-sun"></i> èŠ‚æ°”</label>
            </div>
            <div class="controls">
                <label><i class="fa-solid fa-file"></i> æ—¥å†åç§°: <input type="text" id="calendarName"
                        style="width: auto; flex: 1; margin-left: 8px; margin-top: 5px;">
                </label>
            </div>
            <!-- ä¸»è¦æ“ä½œæŒ‰é’® -->
            <button id="generate" class="generate-btn" style="margin: -8px 0 8px 0;"><i class="fa-solid fa-play"></i>
                ç”Ÿæˆæ•´å¹´äº‹ä»¶</button>
            <div class="controls" style="margin-top: 8px; align-items: center; gap: 8px;">
                <label style="flex: 1; align-items: center;"></i> æŸ¥è¯¢æ—¥æœŸ: <input type="date" id="queryDate"
                        style="width: auto; flex: 1; max-width: 200px; margin-left: 8px;">
                </label>
                <button id="addDayBtn" class="add-day-btn"
                    style="display: none; margin: -15px 0 0 0; padding: 5px 10px; align-self: center; height: 32px;">
                    <i class="fa-solid fa-plus"></i> æ·»åŠ  </button>
            </div>
            <div id="dayJsonContainer">
                <span id="dayJsonToggle"><i class="fa-solid fa-chevron-down"></i> JSON æ•°æ®</span>
                <pre id="dayJson">
			</pre>
            </div>
            <div class="btn-group" style="margin-top: 8px;">
                <button id="copyBtn" class="copy-btn"><i class="fa-solid fa-copy"></i> å¤åˆ¶</button>
                <button id="downloadBtn" class="download-btn"><i class="fa-solid fa-download"></i> ä¸‹è½½</button>
                <button id="clearAllEventsTab2" class="small secondary"><i class="fa-solid fa-trash"></i>
                    æ¸…ç©ºæ‰€æœ‰äº‹ä»¶</button>
            </div>
            <div id="count">
            </div>
            <label style="margin-top: 8px;"><i class="fa-solid fa-code"></i> ICS å†…å®¹</label>
            <textarea id="output" style="background: #0b1220; color: #e6eef8; border: none; font-family: monospace;">// ç‚¹å‡»"ç”Ÿæˆæ•´å¹´äº‹ä»¶"æˆ–"æ·»åŠ "æŒ‰é’®ç”ŸæˆICSå†…å®¹
// ç”Ÿæˆåå¯å¤åˆ¶ã€ç¼–è¾‘æˆ–ä¸‹è½½ICSæ–‡ä»¶</textarea>
            <div id="notify" class="notification">
            </div>
            <h3><i class="fa-solid fa-list"></i> äº‹ä»¶é¢„è§ˆ</h3>
            <div id="eventList"
                style="background: var(--white); padding: 10px; border-radius: 6px; border: 1px solid #ddd; margin-top: 6px;">
            </div>
        </div>
    </div>
    <script src="https://www.0515364.xyz/calendar/js/lunarCalendar.js"></script>
    <script src="https://www.0515364.xyz/calendar/js/icsDescription.js"></script>
    <script>
        // é€‰é¡¹å¡åˆ‡æ¢é€»è¾‘
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                const tabId = btn.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });
        // ------------ é€‰é¡¹ä¸€ ------------
        function showNotificationTab1(type, title, message, duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            let iconClass = 'fa-circle-info';
            if (type === 'success') iconClass = 'fa-circle-check';
            if (type === 'error') iconClass = 'fa-circle-exclamation';
            notification.innerHTML = `
                 <div class="notification-icon">
                     <i class="fa-solid ${iconClass}"></i>
                 </div>
                 <div class="notification-content">
                     <div class="notification-title">${title}</div>
                     <div class="notification-message">${message}</div>
                 </div>
             `;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, duration);
            return notification;
        }
        function setDefaultTimezone() {
            const tzInput = document.getElementById('tz');
            tzInput.value = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Asia/Shanghai';
        }
        window.addEventListener('DOMContentLoaded', setDefaultTimezone);
        document.getElementById('refreshTz').onclick = setDefaultTimezone;
        function makeDTStampLocal(date = new Date()) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            const hh = String(date.getHours()).padStart(2, '0');
            const mi = String(date.getMinutes()).padStart(2, '0');
            const ss = String(date.getSeconds()).padStart(2, '0');
            return `${yyyy}${mm}${dd}T${hh}${mi}${ss}`;
        }
        function formatUID(uid) {
            uid = uid.trim();
            if (!uid) return '';
            return uid.includes('@') ? uid : `${uid}@0515364.xyz`;
        }
        function genUID(base) {
            const rand = Math.random().toString(36).slice(2, 10);
            const now = new Date().getTime();
            const host = (base && base.includes('@')) ? base.split('@').pop() : '0515364.xyz';
            return `${now}-${rand}@${host}`;
        }
        //æ‹¼éŸ³åº“
        function convertToPinyin(text) {
            if (!text) return '';
            const phraseMap = {
                'é‡é˜³èŠ‚': 'chongyangjie',
                'é‡è¦': 'zhongyao',
                'æ—¥æœ¬æŠ•é™': 'ribentouxiang'
            };
            const pinyinMap = {
                'æ•™': 'jiao', 'å¸ˆ': 'shi', 'èŠ‚': 'jie', 'å…ƒ': 'yuan', 'æ—¦': 'dan', 'æ˜¥': 'chun', 'æ¸…': 'qing',
                'æ˜': 'ming', 'åŠ³': 'lao', 'åŠ¨': 'dong', 'ç«¯': 'duan', 'åˆ': 'wu', 'ä¸­': 'zhong', 'ç§‹': 'qiu',
                'å›½': 'guo', 'åº†': 'qing', 'è€¶': 'ye', 'ç¨£': 'su', 'å—': 'shou', 'éš¾': 'nan', 'æ—¥': 'ri', 'å«': 'wei',
                'å¡': 'sai', 'å± ': 'tu', 'å¦–': 'yao', 'åœ£': 'sheng', 'è¯': 'dan', 'å¼€': 'kai', 'å¤§': 'da', 'æ–‹': 'zhai',
                'å“ˆ': 'ha', 'èŠ': 'zhi', 'æ–°': 'xin', 'å†œ': 'nong', 'å†': 'li', 'å¹´': 'nian', 'é™…': 'ji', 'äºº': 'ren',
                'æ°‘': 'min', 'å…±': 'gong', 'å’Œ': 'he', 'æ¤': 'zhi', 'æ ‘': 'shu', 'å„¿': 'er', 'ç«¥': 'tong', 'å»º': 'jian',
                'å…š': 'dang', 'å†›': 'jun', 'é’': 'qing', 'æŠ¤': 'hu', 'å£«': 'shi', 'å…‰': 'guang', 'æ£': 'gun', 'å¤•': 'xi',
                'é‡': 'chong', 'é˜³': 'yang', 'è…Š': 'la', 'ä¸€': 'yi', 'äºŒ': 'er', 'ä¸‰': 'san', 'å››': 'si', 'äº”': 'wu',
                'å…­': 'liu', 'ä¸ƒ': 'qi', 'å…«': 'ba', 'ä¹': 'jiu', 'å': 'shi', 'é›¶': 'ling', 'é¾™': 'long', 'æŠ¬': 'tai',
                'å¤´': 'tou', 'ä¸Š': 'shang', 'å·³': 'si', 'ä¸‹': 'xia', 'åŒ—': 'bei', 'æ–¹': 'fang', 'å°': 'xiao', 'å—': 'nan',
                'å¯’': 'han', 'è¡£': 'yi', 'å®µ': 'xiao', 'è·¨': 'kua', 'å¹³': 'ping', 'å®‰': 'an', 'ä¸–': 'shi', 'ç•Œ': 'jie',
                'é˜²': 'fang', 'æ²»': 'zhi', 'éº»': 'ma', 'é£': 'feng', 'æ¹¿': 'shi', 'æŠ—': 'kang', 'ç™Œ': 'ai', 'æƒ…': 'qing',
                'æµ·': 'hai', 'è±¹': 'bao', 'çˆ±': 'ai', 'è€³': 'er', 'å­¦': 'xue', 'é›·': 'lei', 'é”‹': 'feng', 'å¦‡': 'fu',
                'å¥³': 'nv', 'ç™½': 'bai', 'å¹¸': 'xing', 'ç¦': 'fu', 'ç¡': 'shui', 'çœ ': 'mian', 'æ°´': 'shui', 'æ°”': 'qi',
                'è±¡': 'xiang', 'æ„š': 'yu', 'ç”Ÿ': 'sheng', 'çƒ': 'qiu', 'æ— ': 'wu', 'çƒŸ': 'yan', 'ç¯': 'huan', 'å¢ƒ': 'jing',
                'çŒ®': 'xian', 'è¡€': 'xue', 'è€…': 'zhe', 'ç‘œ': 'yu', 'ä¼½': 'jia', 'å˜': 'bian', 'ç²®': 'liang', 'è”': 'lian',
                'åˆ': 'he', 'è‰¾': 'ai', 'æ»‹': 'zi', 'å¿—': 'zhi', 'æ„¿': 'yuan', 'æƒ': 'quan', 'å¤œ': 'ye', 'å¤': 'xia',
                'æ»¡': 'man', 'èŠ’': 'mang', 'ç§': 'zhong', 'è‡³': 'zhi', 'æš‘': 'shu', 'éœ²': 'lu', 'éœœ': 'shuang', 'å†¬': 'dong',
                'é›ª': 'xue', 'å…¨': 'quan', 'é™¤': 'chu', 'è‰²': 'se', 'åœ°': 'di', 'å®¶': 'jia', 'åº­': 'ting', 'çºª': 'ji',
                'å¿µ': 'nian', 'æ¯': 'mu', 'äº²': 'qin', 'æ´‹': 'yang', 'ç«‹': 'li', 'é›¨': 'yu', 'æƒŠ': 'jing', 'è›°': 'zhe',
                'åˆ†': 'fen', 'è°·': 'gu', 'å¤„': 'chu', 'é™': 'jiang', 'äº‹': 'shi', 'çˆ¶': 'fu', 'åš': 'bo', 'ç‰©': 'wu',
                'é¦†': 'guan', 'å£': 'kou', 'åœŸ': 'tu', 'è‘—': 'zhu', 'æœ¬': 'ben', 'æŠ•': 'tou', 'æˆ˜': 'zhan', 'äº‰': 'zheng',
                'èƒœ': 'sheng', 'åˆ©': 'li', 'è‡­': 'chou', 'æ°§': 'yang', 'å±‚': 'ceng', 'ä¿': 'bao', 'æ—…': 'lv', 'æ¸¸': 'you',
                'è¾›': 'xin', 'äº¥': 'hai', 'é©': 'ge', 'å‘½': 'ming', 'é£Ÿ': 'shi', 'ç—…': 'bing', 'å‘˜': 'yuan', 'æ‰«': 'sao',
                'ç›²': 'mang'
            };
            // å…ˆæŸ¥è¯ç»„
            if (phraseMap[text]) {
                return phraseMap[text];
            }
            // å†é€å­—è½¬æ¢
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (pinyinMap[char]) result += pinyinMap[char];
                else if (/[a-zA-Z0-9]/.test(char)) result += char; // ä¿ç•™å­—æ¯æ•°å­—
            }
            return result;
        }
        function escapeText(s) {
            return (s || '').replace(/\\/g, '\\\\').replace(/;/g, '\\;').replace(/,/g, '\\,').replace(/\n/g, '\\n');
        }
        const eventsContainer = document.getElementById('events');
        let _savedScrollY = null;
        function disableBodyScroll() {
            if (_savedScrollY !== null) return;
            _savedScrollY = window.scrollY || document.documentElement.scrollTop || 0;
            document.body.style.position = 'fixed';
            document.body.style.top = `-${_savedScrollY}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
        }
        function enableBodyScroll() {
            if (_savedScrollY === null) return;
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.right = '';
            window.scrollTo(0, _savedScrollY);
            _savedScrollY = null;
        }
        function refreshEventNumbers() {
            const cards = eventsContainer.querySelectorAll('.card');
            const icons = [
                "fa-star", "fa-heart", "fa-gift", "fa-bell", "fa-flag", "fa-moon",
                "fa-sun", "fa-cake-candles", "fa-music", "fa-seedling", "fa-tree", "fa-smile"
            ];
            cards.forEach((card, i) => {
                const strong = card.querySelector('.event-header strong');
                if (!card.dataset.icon) {
                    card.dataset.icon = icons[Math.floor(Math.random() * icons.length)];
                }
                strong.innerHTML = `<i class="fa-solid ${card.dataset.icon}"></i> äº‹ä»¶ #${i + 1}`;
            });
        }
        function createDialog(title, content, withCopy = false) {
            const backdrop = document.createElement('div');
            backdrop.className = 'dialog-backdrop';
            const box = document.createElement('div');
            box.className = 'dialog-box';
            box.innerHTML = `<h3 style="margin-top:0; font-size: 1rem;">${title}</h3>`;
            if (typeof content === 'string') {
                box.innerHTML += `<pre style="white-space: pre-wrap; word-break: break-all; font-size: 0.85rem; margin: 8px 0;">${content}</pre>`;
            } else {
                box.appendChild(content);
            }
            const actions = document.createElement('div');
            actions.className = 'dialog-actions';
            if (withCopy) {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn small';
                copyBtn.textContent = 'å¤åˆ¶';
                copyBtn.onclick = async () => {
                    try {
                        const toCopy = typeof content === 'string' ? content : (content.innerText || '');
                        await navigator.clipboard.writeText(toCopy);
                        showNotificationTab1('success', 'å·²å¤åˆ¶', 'å†…å®¹å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿');
                    } catch (e) {
                        showNotificationTab1('error', 'å¤åˆ¶å¤±è´¥', 'æ— æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                    }
                };
                actions.appendChild(copyBtn);
            }
            const closeBtn = document.createElement('button');
            closeBtn.className = 'primary small';
            closeBtn.textContent = 'å…³é—­';
            closeBtn.onclick = () => {
                backdrop.remove();
                enableBodyScroll();
            };
            actions.appendChild(closeBtn);
            box.appendChild(actions);
            backdrop.appendChild(box);
            backdrop.addEventListener('touchmove', e => e.preventDefault(), {
                passive: false
            });
            document.body.appendChild(backdrop);
            disableBodyScroll();
        }
        function createEventCard(data) {
            const div = document.createElement('div');
            div.className = 'card';
            const today = new Date();
            const todayDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            div.innerHTML = `
                 <div class="event-header">
                     <strong>äº‹ä»¶</strong>
                     <div class="event-header-actions">
                         <button class="removeBtn secondary small"><i class="fa-solid fa-trash"></i> åˆ é™¤</button>
                         <button class="clearBtn secondary small"><i class="fa-solid fa-eraser"></i> æ¸…ç©º</button>
                     </div>
                 </div>
                 <label><i class="fa-solid fa-fingerprint"></i> UIDï¼ˆå¯ç•™ç©ºéšæœºç”Ÿæˆï¼‰</label>
                 <input class="uid" type="text" value="${data?.uid || ''}" placeholder="ä¾‹å¦‚ï¼šnewyear@0515364.xyz">
                 <div class="uid-status ${data?.uid ? 'manual' : 'auto'}">
                     <i class="fa-solid ${data?.uid ? 'fa-pen' : 'fa-bolt'}"></i> 
                     <span>${data?.uid ? 'æ‰‹åŠ¨è¾“å…¥UID' : 'è‡ªåŠ¨ç”ŸæˆUID'}</span>
                 </div>
                 <label><i class="fa-solid fa-heading"></i> æ ‡é¢˜ï¼ˆSUMMARYï¼‰</label>
                 <input class="summary" type="text" value="${data?.summary || ''}" placeholder="å…ƒæ—¦">
                 <label><i class="fa-solid fa-align-left"></i> è¯´æ˜ï¼ˆDESCRIPTIONï¼Œå¯é€‰ï¼‰</label>
                       <textarea class="description" rows="3" data-manualEdited="${data?.description ? 'true' : 'false'}" placeholder="å…ƒæ—¦ï¼ˆ1æœˆ1æ—¥ï¼‰ï¼Œå…¬å†æ–°å¹´ï¼Œæ ‡å¿—æ–°ä¸€å¹´çš„å¼€å§‹ã€‚ğŸ‰">${data?.description || ''}</textarea>
<div class="desc-status ${data?.description ? 'manual' : 'auto'}">
    <i class="fa-solid ${data?.description ? 'fa-pen' : 'fa-bolt'}"></i> 
    <span>${data?.description ? 'æ‰‹åŠ¨è¾“å…¥è¯´æ˜' : 'è‡ªåŠ¨ç”Ÿæˆè¯´æ˜'}</span>
</div>
                 <div class="date-row">
    <div>
        <label><i class="fa-solid fa-calendar-day"></i> å¼€å§‹ (DTSTART)</label>
        <input class="dtstart" type="date" value="${data?.dtstart ? data.dtstart : todayDate}">
    </div>
    <div>
        <label><i class="fa-solid fa-calendar-check"></i> ç»“æŸ (DTEND)</label>
        <input class="dtend" type="date" value="${data?.dtend
                    ? data.dtend
                    : (() => {
                        const d = new Date(data?.dtstart || todayDate);
                        d.setDate(d.getDate() + 1);
                        const y = d.getFullYear();
                        const m = String(d.getMonth() + 1).padStart(2, '0');
                        const da = String(d.getDate()).padStart(2, '0');
                        return `${y}-${m}-${da}`;
                    })()
                }">
    </div>
</div>
                 <div style="margin-bottom: 8px;">
                     <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                         <input type="checkbox" class="hasTime">
                         <i class="fa-solid fa-clock"></i> æ·»åŠ æ—¶é—´
                     </label>
                     <div class="time-row">
                         <div>
                             <label>å¼€å§‹æ—¶é—´</label>
                             <input class="tstart" type="time" value="00:00">
                         </div>
                         <div>
                             <label>ç»“æŸæ—¶é—´</label>
                             <input class="tend" type="time" value="23:59">
                         </div>
                     </div>
                 </div>
                 <label><i class="fa-solid fa-redo"></i> é‡å¤è§„åˆ™ (RRULE)</label>
                 <select class="rrulePreset" style="margin-bottom: 6px;">
                     <option value="">æ— </option>
                     <option value="YEARLY">æ¯å¹´åŒä¸€å¤©</option>
                     <option value="YEARLY_MONTHDAY">æ¯å¹´åŒæœˆåŒæ—¥</option>
                     <option value="MONTHLY">æ¯æœˆåŒä¸€å¤©</option>
                     <option value="WEEKLY">æ¯å‘¨æŸå¤©</option>
                     <option value="FATHER_DAY">çˆ¶äº²èŠ‚ï¼ˆ6æœˆç¬¬3ä¸ªå‘¨æ—¥ï¼‰</option>
                     <option value="YEARLY_SPECIAL">æ¯äº²èŠ‚ï¼ˆ5æœˆç¬¬2ä¸ªå‘¨æ—¥ï¼‰</option>
                 </select>
                 <input class="rruleCustom" placeholder="è‡ªå®šä¹‰è§„åˆ™ï¼Œä¾‹å¦‚ï¼šFREQ=YEARLY" value="${data?.rrule || ''}">
                 <div class="btn-group">
                     <button class="fillSample small secondary"><i class="fa-solid fa-magic"></i> å¡«ç¤ºä¾‹</button>
                     <button class="ruleInfoBtn small secondary"><i class="fa-solid fa-circle-info"></i> è§„åˆ™ä»‹ç»</button>
                     <button class="previewEventBtn small primary"><i class="fa-solid fa-eye"></i> é¢„è§ˆäº‹ä»¶</button>
                 </div>
             `;
             const hasTime = div.querySelector('.hasTime');
            const timeRow = div.querySelector('.time-row');
            timeRow.style.display = 'none';
            hasTime.addEventListener('change', () => {
                timeRow.style.display = hasTime.checked ? 'flex' : 'none';
            });
            const dtstartInput = div.querySelector('.dtstart');
            const dtendInput = div.querySelector('.dtend');
            const summaryInput = div.querySelector('.summary');
            const uidInput = div.querySelector('.uid');
            const rruleSel = div.querySelector('.rrulePreset');
            const rruleCustom = div.querySelector('.rruleCustom');
            const uidStatus = div.querySelector('.uid-status');
            const descTextarea = div.querySelector('.description');
            const descStatus = div.querySelector('.desc-status');

            // è¯´æ˜è¾“å…¥çŠ¶æ€åˆ‡æ¢
            descTextarea.addEventListener('input', function () {
                if (this.value.trim()) {
                    // æœ‰å†…å®¹ â†’ è®¤ä¸ºæ˜¯æ‰‹åŠ¨è¾“å…¥
                    descStatus.className = 'desc-status manual';
                    descStatus.innerHTML = `<i class="fa-solid fa-pen"></i> <span>æ‰‹åŠ¨è¾“å…¥è¯´æ˜</span>`;
                    this.dataset.manualEdited = 'true';
                } else {
                    // ç©ºå†…å®¹ â†’ è®¤ä¸ºæ˜¯è‡ªåŠ¨ç”Ÿæˆ
                    descStatus.className = 'desc-status auto';
                    descStatus.innerHTML = `<i class="fa-solid fa-bolt"></i> <span>è‡ªåŠ¨ç”Ÿæˆè¯´æ˜</span>`;
                    this.dataset.manualEdited = 'false';
                }
            });

            // UIDè¾“å…¥çŠ¶æ€åˆ‡æ¢
            uidInput.addEventListener('input', function () {
                if (this.value.trim()) {
                    uidStatus.className = 'uid-status manual';
                    uidStatus.innerHTML = `<i class="fa-solid fa-pen"></i> <span>æ‰‹åŠ¨è¾“å…¥UID</span>`;
                } else {
                    uidStatus.className = 'uid-status auto';
                    uidStatus.innerHTML = `<i class="fa-solid fa-bolt"></i> <span>è‡ªåŠ¨ç”ŸæˆUID</span>`;
                }
            });
            summaryInput.addEventListener('input', function () {
                const summaryText = this.value.trim();
                if (summaryText) {
                    if (descStatus.classList.contains('auto')) {
                        // åªæœ‰åœ¨â€œè‡ªåŠ¨æ¨¡å¼â€ä¸‹æ‰ä¼šè¦†ç›–
                        const startDate = dtstartInput.value;
                        let monthDay = '';
                        if (startDate) {
                            const dateObj = new Date(startDate);
                            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                            const day = String(dateObj.getDate()).padStart(2, '0');
                            monthDay = `${month}${day}`;
                        }
                        const autoDesc = window.getDescriptionBySummary(summaryText, monthDay) || '';
                        descTextarea.value = autoDesc;
                        descStatus.className = 'desc-status auto';
                        descStatus.innerHTML = `<i class="fa-solid fa-bolt"></i> <span>è‡ªåŠ¨ç”Ÿæˆè¯´æ˜</span>`;
                        descTextarea.dataset.manualEdited = 'false';
                    }

                    if (uidStatus.classList.contains('auto')) {
                        const pinyinUid = convertToPinyin(summaryText);
                        uidInput.value = pinyinUid ? formatUID(pinyinUid) : '';
                    }
                } else {
                    if (uidStatus.classList.contains('auto')) {
                        uidInput.value = '';
                    }
                    if (descStatus.classList.contains('auto')) {
                        descTextarea.value = '';
                    }
                }
            });
            // å¼€å§‹æ—¥æœŸ <= ç»“æŸæ—¥æœŸ
            dtstartInput.onchange = dtendInput.onchange = () => {
                const start = new Date(dtstartInput.value);
                const end = new Date(dtendInput.value);
                if (end < start) dtendInput.value = dtstartInput.value;
            };
            function updateRRULE() {
                const v = dtstartInput.value;
                if (!v) {
                    rruleCustom.value = '';
                    return;
                }
                const d = new Date(v);
                switch (rruleSel.value) {
                    case 'YEARLY':
                        rruleCustom.value = 'FREQ=YEARLY';
                        break;
                    case 'YEARLY_MONTHDAY':
                        rruleCustom.value = `FREQ=YEARLY;BYMONTH=${d.getMonth() + 1};BYMONTHDAY=${d.getDate()}`;
                        break;
                    case 'MONTHLY':
                        rruleCustom.value = `FREQ=MONTHLY;BYMONTHDAY=${d.getDate()}`;
                        break;
                    case 'WEEKLY':
                        rruleCustom.value = `FREQ=WEEKLY;BYDAY=MO`;
                        break;
                    case 'YEARLY_SPECIAL':
                        rruleCustom.value = 'FREQ=YEARLY;BYMONTH=5;BYDAY=2SU';
                        break;
                    case 'FATHER_DAY':
                        rruleCustom.value = 'FREQ=YEARLY;BYMONTH=6;BYDAY=3SU';
                        break;
                    default:
                        rruleCustom.value = '';
                        break;
                }
            }
            dtstartInput.onchange = () => {
                updateRRULE();
                dtendInput.onchange();
            };
            rruleSel.onchange = updateRRULE;
            // åˆ é™¤äº‹ä»¶
            div.querySelector('.removeBtn').onclick = () => {
                div.remove();
                refreshEventNumbers();
            };
            // æ¸…ç©ºäº‹ä»¶å†…å®¹
            div.querySelector('.clearBtn').onclick = () => {
                uidInput.value = '';
                uidStatus.className = 'uid-status auto';
                uidStatus.innerHTML = `<i class="fa-solid fa-bolt"></i> <span>è‡ªåŠ¨ç”ŸæˆUID</span>`;

                summaryInput.value = '';
                descTextarea.value = '';
                descTextarea.dataset.manualEdited = 'false';
                descStatus.className = 'desc-status auto';
                descStatus.innerHTML = `<i class="fa-solid fa-bolt"></i> <span>è‡ªåŠ¨ç”Ÿæˆè¯´æ˜</span>`;

                dtstartInput.value = todayDate;
                dtendInput.value = todayDate;
                rruleSel.value = '';
                rruleCustom.value = '';
                hasTime.checked = false;
                timeRow.style.display = 'none';
            };
            div.querySelector('.fillSample').onclick = () => {
                summaryInput.value = 'å…ƒæ—¦';
                const desc = window.getDescriptionBySummary('å…ƒæ—¦');
                div.querySelector('.description').value = desc;
                const thisYear = new Date().getFullYear();
                dtstartInput.value = `${thisYear}-01-01`;
                dtendInput.value = `${thisYear}-01-01`;
                rruleSel.value = 'YEARLY';
                rruleCustom.value = 'FREQ=YEARLY';
                // è‡ªåŠ¨ç”ŸæˆUID
                const pinyinUid = convertToPinyin('å…ƒæ—¦');
                if (pinyinUid) uidInput.value = formatUID(pinyinUid);
                // æ˜¾ç¤ºæ—¶é—´é€‰æ‹©
                hasTime.checked = true;
                timeRow.style.display = 'flex';
                div.querySelector('.tstart').value = '00:00';
                div.querySelector('.tend').value = '23:59';
            };
            div.querySelector('.ruleInfoBtn').onclick = () => {
                const text = `â€¢ æ¯å¹´åŒä¸€å¤©ï¼š\nFREQ=YEARLY
         â€¢ æ¯å¹´åŒæœˆåŒæ—¥ï¼š\nFREQ=YEARLY;BYMONTH=9;BYMONTHDAY=10ï¼ˆ9æœˆ10æ—¥ï¼‰
         â€¢ æ¯æœˆåŒä¸€å¤©ï¼š\nFREQ=MONTHLY;BYMONTHDAY=15ï¼ˆæ¯æœˆ15æ—¥ï¼‰
         â€¢ æ¯å‘¨æŸå¤©ï¼š\nFREQ=WEEKLY;BYDAY=MO\nï¼ˆæ¯å‘¨ä¸€ï¼Œå¯é€‰ï¼šMO/TU/WE/TH/FR/SA/SUï¼‰
         â€¢ æ¯äº²èŠ‚ï¼š\nFREQ=YEARLY;BYMONTH=5;BYDAY=2SUï¼ˆ5æœˆç¬¬2ä¸ªå‘¨æ—¥ï¼‰
         â€¢ çˆ¶äº²èŠ‚ï¼š\nFREQ=YEARLY;BYMONTH=6;BYDAY=3SUï¼ˆ6æœˆç¬¬3ä¸ªå‘¨æ—¥ï¼‰`;
                createDialog('RRULE è§„åˆ™è¯´æ˜', text);
            };
            // é¢„è§ˆäº‹ä»¶
            div.querySelector('.previewEventBtn').onclick = () => {
                refreshEventNumbers();
                const ev = readEventFromCard(div);
                const idx = Array.from(eventsContainer.querySelectorAll('.card')).indexOf(div) + 1;
                if (!ev.summary) {
                    showNotificationTab1('error', 'é¢„è§ˆå¤±è´¥', `äº‹ä»¶ ${idx} æ ‡é¢˜ä¸ºç©ºï¼`);
                    return;
                }
                let text = buildSingleEventICS(ev).replace(/\\n/g, '\n');
                createDialog(`äº‹ä»¶ ${idx} ICS é¢„è§ˆ`, text, true);
            };
            eventsContainer.appendChild(div);
            refreshEventNumbers();
            return div;
        }
        function readEventFromCard(card) {
            const uid = card.querySelector('.uid').value.trim();
            const summary = card.querySelector('.summary').value.trim();
            const description = card.querySelector('.description').value.trim();
            const dtstartRaw = card.querySelector('.dtstart').value;
            const dtendRaw = card.querySelector('.dtend').value;
            const hasTime = card.querySelector('.hasTime').checked;
            const tstart = card.querySelector('.tstart')?.value || "00:00";
            const tend = card.querySelector('.tend')?.value || "00:00";
            const rrule = card.querySelector('.rruleCustom').value.trim();
            let dtstart = "",
                dtend = "";
            if (dtstartRaw) {
                dtstart = hasTime ? dtstartRaw.replace(/-/g, '') + 'T' + tstart.replace(':', '') + '00' : dtstartRaw.replace(/-/g, '');
            }
            if (dtendRaw) {
                dtend = hasTime ? dtendRaw.replace(/-/g, '') + 'T' + tend.replace(':', '') + '00' : dtendRaw.replace(/-/g, '');
            }
            return {
                uid,
                summary,
                description,
                allDay: !hasTime,
                dtstart,
                dtend,
                rrule
            };
        }
        function buildSingleEventICS(ev) {
            const lines = ['BEGIN:VEVENT'];
            lines.push(`UID:${ev.uid || genUID()}`);
            lines.push(`DTSTAMP:${makeDTStampLocal(new Date())}Z`);
            lines.push(`SUMMARY:${escapeText(ev.summary)}`);
            if (ev.allDay) {
                lines.push(`DTSTART;VALUE=DATE:${ev.dtstart}`);
                lines.push(`DTEND;VALUE=DATE:${ev.dtend}`);
            } else {
                lines.push(`DTSTART;VALUE=DATE:${ev.dtstart}`);
                lines.push(`DTEND;VALUE=DATE:${ev.dtend}`);
            }
            if (ev.description.trim()) {
                lines.push(`DESCRIPTION:${escapeText(ev.description)}`);
            }
            if (ev.rrule) {
                lines.push(`RRULE:${ev.rrule}`);
            }

            lines.push('END:VEVENT');
            return lines.join('\r\n');
        }
        function buildCalendarICS() {
            const calName = document.getElementById('calName').value || 'æˆ‘çš„è®¢é˜…æ—¥å†';
            const tz = document.getElementById('tz').value || Intl.DateTimeFormat().resolvedOptions().timeZone || '';
            document.getElementById('tz').value = tz;
            const prodid = document.getElementById('prodid').value || '-//0515364.xyz//My Calendar//CN';
            const header = [
                'BEGIN:VCALENDAR',
                `PRODID:${prodid}`,
                'VERSION:2.0',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                `X-WR-CALNAME:${escapeText(calName)}`,
                'X-APPLE-CALENDAR-COLOR:#FF9500',
                `X-WR-TIMEZONE:${tz}`
            ];
            const eventCards = Array.from(document.querySelectorAll('#events .card'));
            if (eventCards.length === 0) {
                createEventCard();
                return '';
            }
            refreshEventNumbers();
            for (let i = 0; i < eventCards.length; i++) {
                const summary = eventCards[i].querySelector('.summary').value.trim();
                if (!summary) {
                    showNotificationTab1('error', 'ç”Ÿæˆå¤±è´¥', `äº‹ä»¶ ${i + 1} æ ‡é¢˜ä¸ºç©ºï¼`);
                    return '';
                }
            }
            const events = eventCards.map(c => buildSingleEventICS(readEventFromCard(c))).join('\r\n\r\n');
            return header.join('\r\n') + '\r\n\r\n' + events + '\r\n\r\nEND:VCALENDAR\r\n';
        }
        // é€‰é¡¹ä¸€æŒ‰é’®äº‹ä»¶ç»‘å®š
        document.getElementById('addEventBtn').onclick = () => createEventCard();
        document.getElementById('clearEvents').onclick = () => {
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰äº‹ä»¶å—ï¼Ÿ')) {
                eventsContainer.innerHTML = '';
                createEventCard();
            }
        };
        document.getElementById('generateBtn').onclick = () => {
            const ics = buildCalendarICS();
            if (!ics) return;
            document.getElementById('preview').textContent = ics.replace(/\\n/g, '\n');
            showNotificationTab1('success', 'ç”ŸæˆæˆåŠŸ', 'ICS å†…å®¹å·²ç”Ÿæˆï¼Œè¯·æŸ¥çœ‹é¢„è§ˆåŒºåŸŸ');
        };
        document.getElementById('copyBtnTab1').onclick = async () => {
            const text = document.getElementById('preview').textContent;
            if (text.startsWith('// ')) {
                showNotificationTab1('error', 'å¤åˆ¶å¤±è´¥', 'è¯·å…ˆç”Ÿæˆ ICS å†…å®¹');
                return;
            }
            try {
                await navigator.clipboard.writeText(text);
                showNotificationTab1('success', 'å¤åˆ¶æˆåŠŸ', 'ICS å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (e) {
                showNotificationTab1('error', 'å¤åˆ¶å¤±è´¥', 'æ— æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
        };
        document.getElementById('downloadBtnTab1').onclick = () => {
            const text = document.getElementById('preview').textContent;
            if (text.startsWith('// ')) {
                showNotificationTab1('error', 'ä¸‹è½½å¤±è´¥', 'è¯·å…ˆç”Ÿæˆ ICS å†…å®¹');
                return;
            }
            const blob = new Blob([text], {
                type: 'text/calendar;charset=utf-8'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'calendar.ics';
            a.click();
            URL.revokeObjectURL(url);
            showNotificationTab1('success', 'ä¸‹è½½æˆåŠŸ', 'ICS æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½');
        };
        // åˆå§‹åŒ–é€‰é¡¹ä¸€äº‹ä»¶
        createEventCard();
        // ------------ é€‰é¡¹äºŒ ------------
        function pad(n) {
            return n < 10 ? "0" + n : n;
        }
        let eventData = [];
        let lastDayInfo = null;
        let currentTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        // ç”Ÿæˆæ•´å¹´äº‹ä»¶
        function generateICS2() {
            const year = parseInt(document.getElementById("year").value, 10);
            if (isNaN(year)) {
                showNotificationTab1('error', 'æ“ä½œå¤±è´¥', "è¯·è¾“å…¥æœ‰æ•ˆå¹´ä»½ï¼");
                return;
            }
            const incSolar = document.getElementById("chkSolar").checked;
            const incLunar = document.getElementById("chkLunar").checked;
            const incOther = document.getElementById("chkOther").checked;
            const incTerm = document.getElementById("chkTerm").checked;
            if (!incSolar && !incLunar && !incOther && !incTerm) {
                showNotificationTab1('error', 'æ“ä½œå¤±è´¥', "è¯·è‡³å°‘å‹¾é€‰ä¸€ä¸ªäº‹ä»¶ç±»å‹ï¼");
                return;
            }
            const data = LunarCalendar.getYearCalendar(year);
            const now = new Date();
            const dtstamp = now.toISOString().replace(/[-:]/g, "").split(".")[0];
            eventData = [];
            data.forEach(item => {
                let festName = "";
                if (incSolar && item.isSolarFestival) festName = item.solarFestival;
                else if (incLunar && item.isLunarFestival) festName = item.lunarFestival;
                else if (incOther && item.isOtherFestival) festName = item.otherFestival;
                else if (incTerm && item.isSolarTerm) festName = item.solarTerm;
                if (festName) {
                    const d = new Date(item.date);
                    const y = d.getFullYear();
                    const m = pad(d.getMonth() + 1);
                    const da = pad(d.getDate());
                    const monthDay = `${m}${da}`;
                    const endDate = new Date(d);
                    endDate.setDate(endDate.getDate() + 1); // +1 å¤©
                    const ey = endDate.getFullYear();
                    const em = pad(endDate.getMonth() + 1);
                    const ed = pad(endDate.getDate());
                    const uid = convertToPinyin(festName) + "@0515364.xyz";
                    const festDesc = window.getDescriptionBySummary(festName, monthDay) || festName;
                    eventData.push({
                        uid,
                        name: festName,
                        start: `${y}${m}${da}`,
                        end: `${ey}${em}${ed}`,
                        dtstamp,
                        description: festDesc
                    });
                }
            });
            document.getElementById("output").value = "";
            updateICS2();
            showNotificationTab1('success', 'æ“ä½œæˆåŠŸ', "æ•´å¹´äº‹ä»¶ç”Ÿæˆå®Œæˆï¼Œå…± " + eventData.length + " ä¸ªäº‹ä»¶");
        }
        function updateICS2() {
            const calName = document.getElementById("calendarName").value || "æˆ‘çš„æ—¥å†";
            if (!eventData.length) {
                document.getElementById("output").value = "";
                document.getElementById("count").textContent = "";
                renderEventList2();
                return;
            }
            const events = eventData.map(e => `
BEGIN:VEVENT
UID:${e.uid}
DTSTAMP:${e.dtstamp}Z
SUMMARY:${e.name}
DTSTART;VALUE=DATE:${e.start}
DTEND;VALUE=DATE:${e.end}
DESCRIPTION:${escapeText(e.description || e.name)}
END:VEVENT`).join("\n");
            const ics = `BEGIN:VCALENDAR
PRODID:-//0515364.xyz//My Calendar//CN
VERSION:2.0
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:${calName}
X-APPLE-CALENDAR-COLOR:#FF9500
X-WR-TIMEZONE:${currentTimeZone}
${events}\n
END:VCALENDAR`;
            document.getElementById("output").value = ics;
            document.getElementById("count").textContent = `âœ… å½“å‰å…±æœ‰ ${eventData.length} ä¸ªäº‹ä»¶`;
            renderEventList2();
        }
        function parseICSFromTextarea2() {
            const text = document.getElementById("output").value;
            if (!text.includes("BEGIN:VEVENT")) return;
            const events = text.split("BEGIN:VEVENT").slice(1).map(e => "BEGIN:VEVENT" + e.trim());
            eventData = events.map(evt => {
                const descMatch = evt.match(/DESCRIPTION:(.+)/);
                const description = descMatch ? descMatch[1].trim() : "";
                return {
                    uid: (evt.match(/UID:(.+)/) || [])[1] || "",
                    dtstamp: (evt.match(/DTSTAMP:(.+)/) || [])[1] || "",
                    name: (evt.match(/SUMMARY:(.+)/) || [])[1] || "",
                    start: (evt.match(/DTSTART:(.+)/) || [])[1] || "",
                    end: (evt.match(/DTEND:(.+)/) || [])[1] || "",
                    description: description
                };
            });
            renderEventList2();
        }
        function renderEventList2() {
            const list = document.getElementById("eventList");
            list.innerHTML = "";
            if (!eventData.length) {
                list.innerHTML = "<p style='color:var(--text-muted);'><i class='fa-solid fa-circle-info'></i> æš‚æ— äº‹ä»¶</p>";
                return;
            }
            eventData.forEach((e, i) => {
                const div = document.createElement("div");
                div.className = "event-item";
                div.innerHTML = `
                     <span class="event-name">${i + 1}. ${e.name}ï¼ˆ${e.start.slice(0, 4)}-${e.start.slice(4, 6)}-${e.start.slice(6, 8)}ï¼‰</span>
                     <button class="delete-btn small secondary" onclick="deleteEvent('${e.uid}')">
                         <i class='fa-solid fa-trash'></i> åˆ é™¤
                     </button>
                 `;
                list.appendChild(div);
            });
        }
        function deleteEvent(uid) {
            const eventToDelete = eventData.find(e => e.uid === uid);
            const festName = eventToDelete ? eventToDelete.name : "æœªçŸ¥äº‹ä»¶";
            eventData = eventData.filter(e => e.uid !== uid);
            if (!eventData.length) {
                document.getElementById("output").value =
                    '// ç‚¹å‡»"ç”Ÿæˆæ•´å¹´äº‹ä»¶"æˆ–"æ·»åŠ "æŒ‰é’®ç”ŸæˆICSå†…å®¹\n' +
                    '// ç”Ÿæˆåå¯å¤åˆ¶ã€ç¼–è¾‘æˆ–ä¸‹è½½ICSæ–‡ä»¶';
                document.getElementById("count").textContent = "";
            } else {
                updateICS2();
            }
            showNotificationTab1('success', 'æ“ä½œæˆåŠŸ', `äº‹ä»¶ã€Œ${festName}ã€å·²åˆ é™¤`);
            renderEventList2();
        }
        function querySingleDay(dateStr) {
            const d = new Date(dateStr);
            const year = d.getFullYear();
            const data = LunarCalendar.getDayInfo(year, d.getMonth() + 1, d.getDate());
            lastDayInfo = {
                date: d,
                info: data
            };
            document.getElementById("dayJson").textContent = JSON.stringify(data, null, 2);
            document.getElementById("dayJson").style.display = "block";
            document.getElementById("dayJsonToggle").innerHTML = '<i class="fa-solid fa-chevron-down"></i> JSON æ•°æ®';
            const hasFest = data && (data.solarFestival || data.lunarFestival || data.otherFestival || data.solarTerm);
            document.getElementById("addDayBtn").style.display = hasFest ? "inline-flex" : "none";
        }
        document.getElementById("dayJsonToggle").addEventListener("click", () => {
            const pre = document.getElementById("dayJson");
            if (pre.style.display === "none") {
                pre.style.display = "block";
                document.getElementById("dayJsonToggle").innerHTML = '<i class="fa-solid fa-chevron-down"></i> JSON æ•°æ®';
            } else {
                pre.style.display = "none";
                document.getElementById("dayJsonToggle").innerHTML = '<i class="fa-solid fa-chevron-right"></i> JSON æ•°æ®';
            }
        });
        // æ·»åŠ å•æ—¥äº‹ä»¶
        document.getElementById("addDayBtn").addEventListener("click", () => {
            if (!lastDayInfo) return;
            const data = lastDayInfo.info;
            const d = lastDayInfo.date;
            let festName = data.solarTerm || data.lunarFestival || data.solarFestival || data.otherFestival;
            if (!festName) return;
            const y = d.getFullYear();
            const m = pad(d.getMonth() + 1);
            const da = pad(d.getDate());
            const monthDay = `${m}${da}`;
            const dateStr = `${y}${m}${da}`;
            const endDate = new Date(d);
            endDate.setDate(endDate.getDate() + 1);
            const ey = endDate.getFullYear();
            const em = pad(endDate.getMonth() + 1);
            const ed = pad(endDate.getDate());
            const endStr = `${ey}${em}${ed}`;
            const exist = eventData.find(e => e.name === festName && e.start.startsWith(dateStr));
            if (exist) {
                showNotificationTab1('error', 'æ“ä½œå¤±è´¥', "âš ï¸ å·²æœ‰ç›¸åŒæ—¥æœŸå’ŒèŠ‚æ—¥/èŠ‚æ°”ï¼");
                return;
            }
            const now = new Date();
            const dtstamp = now.toISOString().replace(/[-:]/g, "").split(".")[0];
            const uid = convertToPinyin(festName) + "@0515364.xyz";
            const festDesc = window.getDescriptionBySummary(festName, monthDay) || festName;
            eventData.push({
                uid,
                name: festName,
                start: dateStr,
                end: endStr,
                dtstamp,
                description: festDesc
            });
            document.getElementById("output").value = "";
            updateICS2();
            showNotificationTab1('success', 'æ“ä½œæˆåŠŸ', `å·²æ·»åŠ ã€Œ${festName}ã€å•æ—¥äº‹ä»¶`);
        });
        // é€‰é¡¹äºŒæŒ‰é’®äº‹ä»¶ç»‘å®š
        document.getElementById("generate").addEventListener("click", generateICS2);
        document.getElementById("copyBtn").addEventListener("click", async () => {
            const icsContent = document.getElementById("output").value.trim();
            if (!icsContent || icsContent.startsWith("// ç‚¹å‡»")) {
                showNotificationTab1('error', 'å¤åˆ¶å¤±è´¥', "è¯·å…ˆç”ŸæˆICSå†…å®¹");
                return;
            }
            try {
                await navigator.clipboard.writeText(icsContent);
                showNotificationTab1('success', 'å¤åˆ¶æˆåŠŸ', "ICSå†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
            } catch (e) {
                showNotificationTab1('error', 'å¤åˆ¶å¤±è´¥', "æ— æ³•è®¿é—®å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶");
            }
        });
        document.getElementById("downloadBtn").addEventListener("click", () => {
            if (!eventData.length) {
                showNotificationTab1('error', 'æ“ä½œå¤±è´¥', "è¯·å…ˆç”ŸæˆICSå†…å®¹");
                return;
            }
            const blob = new Blob([document.getElementById("output").value], {
                type: "text/calendar;charset=utf-8"
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "my_calendar.ics";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotificationTab1('success', 'æ“ä½œæˆåŠŸ', "ICS æ–‡ä»¶å·²ä¸‹è½½");
        });
        document.getElementById("clearAllEventsTab2").addEventListener("click", () => {
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰äº‹ä»¶å—ï¼Ÿ')) {
                eventData = [];
                updateICS2();
                document.getElementById("output").value = "// ç‚¹å‡»\"ç”Ÿæˆæ•´å¹´äº‹ä»¶\"æˆ–\"æ·»åŠ \"æŒ‰é’®ç”ŸæˆICSå†…å®¹\n// ç”Ÿæˆåå¯å¤åˆ¶ã€ç¼–è¾‘æˆ–ä¸‹è½½ICSæ–‡ä»¶";
                showNotificationTab1('success', 'æ“ä½œæˆåŠŸ', "æ‰€æœ‰äº‹ä»¶å·²æ¸…ç©º");
            }
        });
        document.addEventListener('DOMContentLoaded', function () {
            const yearInput = document.getElementById('year');
            const calendarNameInput = document.getElementById('calendarName');
            const currentYear = new Date().getFullYear().toString();
            yearInput.value = currentYear;
            calendarNameInput.value = `${currentYear}è®¢é˜…æ—¥å†`;
            yearInput.addEventListener('input', function () {
                const inputYear = yearInput.value.trim() || currentYear;
                calendarNameInput.value = `${inputYear}è®¢é˜…æ—¥å†`;
            });
        });
        document.getElementById("output").addEventListener("change", parseICSFromTextarea2);
        const today = new Date();
        document.getElementById("queryDate").value = today.toISOString().split("T")[0];
        querySingleDay(document.getElementById("queryDate").value);
        document.getElementById("queryDate").addEventListener("change", e => {
            querySingleDay(e.target.value);
        });
        document.addEventListener("DOMContentLoaded", () => {
            const dtstart = document.querySelector(".dtstart");
            const dtend = document.querySelector(".dtend");
            const hasTime = document.querySelector(".hasTime");
            function pad(n) {
                return String(n).padStart(2, '0');
            }
            function updateEndDate() {
                if (!dtstart.value) return;
                if (hasTime.checked) {
                    dtend.value = dtstart.value;
                } else {
                    const d = new Date(dtstart.value);
                    d.setDate(d.getDate() + 1);
                    dtend.value = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
                }
            }
            updateEndDate();
            dtstart.addEventListener("change", updateEndDate);
            hasTime.addEventListener("change", updateEndDate);
        });
        document.addEventListener("DOMContentLoaded", () => {
            const tabButtons = document.querySelectorAll(".tab-btn");
            const tabContents = document.querySelectorAll(".tab-content");
            function activateTab(tabId) {
                tabContents.forEach(tab => {
                    tab.style.display = (tab.id === tabId) ? "block" : "none";
                });
                tabButtons.forEach(btn => {
                    btn.classList.toggle("active", btn.dataset.tab === tabId);
                });
                setTimeout(() => {
                    window.scrollTo(0, 0);
                }, 50);
            }
            function showTabFromHash() {
                const hash = window.location.hash || "#tab1";
                const targetId = hash.substring(1);
                activateTab(targetId);
            }
            showTabFromHash();
            window.addEventListener("hashchange", showTabFromHash);
            tabButtons.forEach(btn => {
                btn.addEventListener("click", () => {
                    const tabId = btn.dataset.tab;
                    activateTab(tabId);
                });
            });
        });
    </script>
</body>

</html>
