<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸ªäººç½‘ç›˜</title>
  <style>
    body { font-family: sans-serif; margin: 1rem; }
    #panel { display: none; }
    #fileList li { margin: .5em 0; }
    button { margin-right: .5em; }
  </style>
</head>
<body>
  <h2>ğŸ“ ä¸ªäººç½‘ç›˜</h2>
  <div id="login">
    <input type="password" id="pwd" placeholder="è¯·è¾“å…¥å¯†ç " />
    <button onclick="login()">ç™»å½•</button>
  </div>

  <div id="panel">
    <p>å½“å‰è§’è‰²ï¼š<b id="role"></b></p>
    <input type="file" id="fileInput" multiple />
    <button onclick="upload()">ä¸Šä¼ </button>
    <button onclick="batchDelete()">æ‰¹é‡åˆ é™¤</button>
    <button onclick="newDir()">æ·»åŠ æ–‡ä»¶å¤¹</button>
    <button onclick="loadFiles()">åˆ·æ–°åˆ—è¡¨</button>
    <h3>æ–‡ä»¶ / æ–‡ä»¶å¤¹</h3>
    <ul id="fileList"></ul>
    <h3>å›æ”¶ç«™ï¼ˆç®¡ç†å‘˜ï¼‰</h3>
    <ul id="trashList"></ul>
  </div>

  <script>
    let auth = ''
    let role = ''

    async function login() {
      auth = document.getElementById("pwd").value.trim()
      const res = await fetch("https://pan.0515364.xyz/whoami", {
        method: "POST",
        body: auth
      })
      const json = await res.json()
      if (json.role) {
        role = json.role
        document.getElementById("login").style.display = "none"
        document.getElementById("panel").style.display = "block"
        document.getElementById("role").textContent = role
        loadFiles()
        if (role === 'admin') loadTrash()
      } else {
        alert("å¯†ç é”™è¯¯")
      }
      document.getElementById("pwd").value = ''
    }

    async function loadFiles() {
      const res = await fetch(`https://pan.0515364.xyz/list?key=${auth}`)
      const files = await res.json()
      const ul = document.getElementById("fileList")
      ul.innerHTML = ''
      files.forEach(f => {
        const li = document.createElement('li')
        li.textContent = f.name + (f.uploader ? ` (ä¸Šä¼ è€…: ${f.uploader})` : '')
        const dl = document.createElement('a')
        dl.href = `https://pan.0515364.xyz/download?file=${encodeURIComponent(f.name)}&key=${auth}`
        dl.textContent = " ä¸‹è½½"
        dl.target = "_blank"
        li.append(dl)
        if ((role === 'admin') || (role === 'upload' && f.uploader === auth)) {
          const del = document.createElement('button')
          del.textContent = "åˆ é™¤"
          del.onclick = () => {
            if (confirm("ç¡®è®¤åˆ é™¤ " + f.name + " å—ï¼Ÿ")) deleteFile(f.name)
          }
          li.append(del)
        }
        ul.append(li)
      })
    }

    async function upload() {
      const files = document.getElementById("fileInput").files
      if (files.length === 0) return alert("è¯·å…ˆé€‰æ‹©æ–‡ä»¶")
      for (const file of files) {
        const form = new FormData()
        form.append('file', file)
        form.append('key', auth)
        const res = await fetch('https://pan.0515364.xyz/upload', {
          method: "POST",
          body: form
        })
        const txt = await res.text()
        alert(txt)
      }
      loadFiles()
    }

    async function deleteFile(name) {
      await fetch(`https://pan.0515364.xyz/delete?file=${encodeURIComponent(name)}&key=${auth}`, {
        method: "GET"
      })
      loadFiles()
      if (role === 'admin') loadTrash()
    }

    async function batchDelete() {
      if (!confirm("ç¡®è®¤æ‰¹é‡åˆ é™¤æ‰€æœ‰å¯è§æ–‡ä»¶å—ï¼Ÿ")) return
      const res = await fetch(`https://pan.0515364.xyz/batchdel?key=${auth}`, { method: "POST" })
      alert(await res.text())
      loadFiles()
      if (role === 'admin') loadTrash()
    }

    async function newDir() {
      const name = prompt("æ–°å»ºæ–‡ä»¶å¤¹åï¼š")
      if (!name) return
      const res = await fetch('https://pan.0515364.xyz/mkdir', {
        method: "POST",
        body: JSON.stringify({ name, key: auth })
      })
      alert(await res.text())
      loadFiles()
    }

    async function loadTrash() {
      const res = await fetch(`https://pan.0515364.xyz/trash/list?key=${auth}`)
      const trs = await res.json()
      const ul = document.getElementById("trashList")
      ul.innerHTML = ''
      trs.forEach(f => {
        const li = document.createElement('li')
        li.textContent = f.name + ` (åˆ é™¤æ—¶é—´: ${new Date(f.deletedAt).toLocaleString()})`
        ul.append(li)
      })
    }
  </script>
</body>
</html>