<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>ICS 事件生成器 - 0515364.xyz</title>
<style>
:root{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
body{margin:0;padding:20px;background:#f6f7fb;color:#111;box-sizing:border-box;min-height:100vh;display:flex;flex-direction:column;gap:16px}
h1{margin:0;font-size:1.25rem}
.container{max-width:900px;margin:0 auto;width:100%}
.card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 1px 6px rgba(20,20,40,0.06);margin-bottom:12px}
label{display:block;font-size:0.9rem;margin-bottom:6px;color:#333}
input[type="text"], input[type="date"], select, textarea{
  width:100%;padding:8px;border:1px solid #e2e6ef;border-radius:6px;font-size:0.95rem;box-sizing:border-box;
}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
button{padding:10px 14px;border:0;border-radius:8px;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
button.secondary{background:#6b7280}
.small{padding:6px 10px;font-size:0.9rem}
.events-list{display:flex;flex-direction:column;gap:8px}
.event-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
.preview{white-space:pre;overflow:auto;max-height:360px;padding:12px;background:#0b1220;color:#e6eef8;font-family:monospace;border-radius:8px}
.meta-row{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
.muted{color:#6b7280;font-size:0.9rem}
.rruleCustom{min-width:300px;font-family:monospace;}
.date-block{margin-top:8px}
@media (max-width:640px){
  .row{flex-direction:column}
  .event-header{flex-direction:column;align-items:flex-start}
}
</style>
</head>
<body>
<div class="container">
  <h1>ICS 事件生成器</h1>
  <div class="card">
    <label>日历名称（X-WR-CALNAME）</label>
    <input id="calName" type="text" value="我的订阅日历" placeholder="例如：我的订阅日历">
    <label>时区 (X-WR-TIMEZONE)
      <button id="refreshTz" class="small secondary" style="margin-left:8px;background:#ef4444;">重置</button>
    </label>
    <input id="tz" type="text" placeholder="例如：Asia/Shanghai">
    <label>PRODID</label>
    <input id="prodid" type="text" value="-//0515364.xyz//My Calendar//CN">
  </div>

  <div class="card">
    <strong>事件列表</strong>
    <div id="events" class="events-list" style="margin-top:12px"></div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="addEventBtn" class="small">添加事件</button>
      <button id="clearEvents" class="small secondary">清空所有</button>
    </div>
    <div class="muted" style="margin-top:8px">说明：<br>
• UID 可留空，系统会自动生成；<br>
• DTSTAMP 自动填写为当前 UTC 时间；<br>
• 默认全天事件，无法添加时间；<br>
• 修改重复规则请查看规则介绍。
</div>
  </div>

  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button id="generateBtn">生成 .ics 并预览</button>
    <button id="copyBtn" class="secondary">复制到剪贴板</button>
    <button id="downloadBtn" class="secondary">下载 .ics</button>
  </div>

  <div class="card">
    <label>预览 (.ics)</label>
    <div id="preview" class="preview">// 点击“生成 .ics 并预览”查看结果</div>
  </div>
</div>

<script>
function setDefaultTimezone(){
  const tzInput = document.getElementById('tz');
  tzInput.value = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Asia/Shanghai';
}
window.addEventListener('DOMContentLoaded', setDefaultTimezone);
document.getElementById('refreshTz').onclick = setDefaultTimezone;

function makeDTStampUTC(date=new Date()){
  const iso=date.toISOString();
  return iso.replace(/\.\d{3}Z$/,'Z').replace(/[-:]/g,'');
}
function genUID(base){const rand=Math.random().toString(36).slice(2,10);const now=new Date().getTime();const host=(base&&base.includes('@'))?base.split('@').pop():'0515364.xyz';return`uid-${now}-${rand}@${host}`;}
function foldLine(line){const max=75;if(line.length<=max)return line;let out='',pos=0;while(pos<line.length){if(pos===0){out+=line.slice(pos,pos+max);}else{out+='\r\n '+line.slice(pos,pos+max);}pos+=max;}return out;}
function escapeText(s){return(s||'').replace(/\\/g,'\\\\').replace(/;/g,'\\;').replace(/,/g,'\\,').replace(/\n/g,'\\n');}

const eventsContainer=document.getElementById('events');

function refreshEventNumbers(){
  const cards = eventsContainer.querySelectorAll('.card');
  cards.forEach((card, i)=>{
    const strong = card.querySelector('.event-header strong');
    strong.textContent = `事件 #${i+1}`;
  });
}

function createEventCard(data){
  const div=document.createElement('div');
  div.className='card';

  const today=new Date();
  const yyyy=today.getFullYear(),mm=String(today.getMonth()+1).padStart(2,'0'),dd=String(today.getDate()).padStart(2,'0');
  const todayDate=`${yyyy}-${mm}-${dd}`;

  div.innerHTML=`
    <div class="event-header">
      <strong>事件</strong>
      <div style="display:flex;gap:6px">
        <button class="removeBtn secondary small">删除</button>
        <button class="clearBtn secondary small">清空当前事件</button>
      </div>
    </div>
    <label>UID（可留空自动生成）</label>
    <input class="uid" type="text" value="${data?.uid||''}" placeholder="例如：teacher@0515364.xyz">
    <label>标题（SUMMARY）</label>
    <input class="summary" type="text" value="${data?.summary||''}" placeholder="教师节">
    <label>说明（DESCRIPTION，可选）</label>
    <input class="description" type="text" value="${data?.description||''}" placeholder="每年教师节">
    <div class="date-row" style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap;">
    <div style="flex:1;display:flex;flex-direction:column;">
    <label>开始 (DTSTART)</label>
    <input class="dtstart" type="date" value="${todayDate}" style="width:100%;">
  </div>
    <div style="flex:1;display:flex;flex-direction:column;">
    <label>结束 (DTEND)</label>
    <input class="dtend" type="date" value="${todayDate}" style="width:100%;">
  </div>
</div>
    <label>重复规则 (RRULE)</label>
    <select class="rrulePreset">
      <option value="">无</option>
      <option value="YEARLY">每年同一天</option>
      <option value="YEARLY_MONTHDAY">每年同月同日</option>
      <option value="MONTHLY">每月同一天</option>
      <option value="WEEKLY">每周某天</option>
      <option value="FATHER_DAY">父亲节（6月第3个周日）</option>
      <option value="YEARLY_SPECIAL">母亲节（5月第2个周日）</option>
    </select>
    <input class="rruleCustom rruleCustom" placeholder="例如：FREQ=YEARLY;BYMONTH=9;BYMONTHDAY=10">
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="fillSample small secondary">填示例</button>
      <button class="ruleInfoBtn small secondary">规则介绍</button>
      <button class="previewEventBtn small">预览事件 ICS</button>
    </div>
  `;

  const dtstartInput=div.querySelector('.dtstart');
  const dtendInput=div.querySelector('.dtend');

  dtstartInput.onchange=dtendInput.onchange=()=>{
    const start = new Date(dtstartInput.value);
    const end = new Date(dtendInput.value);
    if(end<start) dtendInput.value = dtstartInput.value;
  };

  const rruleSel=div.querySelector('.rrulePreset');
  const rruleCustom=div.querySelector('.rruleCustom');
  function updateRRULE(){
    const v=dtstartInput.value;
    if(!v){rruleCustom.value=''; return;}
    const d=new Date(v);
    switch(rruleSel.value){
      case 'YEARLY': rruleCustom.value='FREQ=YEARLY'; break;
      case 'YEARLY_MONTHDAY': rruleCustom.value=`FREQ=YEARLY;BYMONTH=${d.getMonth()+1};BYMONTHDAY=${d.getDate()}`; break;
      case 'MONTHLY': rruleCustom.value=`FREQ=MONTHLY;BYMONTHDAY=${d.getDate()}`; break;
      case 'WEEKLY': rruleCustom.value=`FREQ=WEEKLY;BYDAY=MO`; break;
      case 'YEARLY_SPECIAL': rruleCustom.value='FREQ=YEARLY;BYMONTH=5;BYDAY=2SU'; break;
      case 'FATHER_DAY': rruleCustom.value='FREQ=YEARLY;BYMONTH=6;BYDAY=3SU'; break;
      default: rruleCustom.value=''; break;
    }
  }
  dtstartInput.onchange=()=>{updateRRULE(); dtendInput.onchange();}
  rruleSel.onchange=updateRRULE;

  div.querySelector('.removeBtn').onclick=()=>{
    div.remove();
    refreshEventNumbers();
  };
  div.querySelector('.clearBtn').onclick=()=>{
    div.querySelector('.uid').value='';
    div.querySelector('.summary').value='';
    div.querySelector('.description').value='';
    dtstartInput.value=todayDate;
    dtendInput.value=todayDate;
    rruleSel.value='';
    rruleCustom.value='';
  };

  div.querySelector('.fillSample').onclick=()=>{
    div.querySelector('.summary').value='示例事件';
    dtstartInput.value=todayDate;
    dtendInput.value=todayDate;
    rruleSel.value='';
    rruleCustom.value='';
  };
  
  div.querySelector('.ruleInfoBtn').onclick=()=>{alert(`RRULE 规则说明：
• 每年同一天：FREQ=YEARLY
• 每年同月同日：FREQ=YEARLY;BYMONTH=9;BYMONTHDAY=10
• 每月同一天：FREQ=MONTHLY;BYMONTHDAY=15
• 每周某天：FREQ=WEEKLY;BYDAY=MO
• 母亲节：FREQ=YEARLY;BYMONTH=5;BYDAY=2SU
• 父亲节：FREQ=YEARLY;BYMONTH=6;BYDAY=3SU`);};

div.querySelector('.previewEventBtn').onclick=()=>{
    refreshEventNumbers();
    const ev = readEventFromCard(div);
    const idx = Array.from(eventsContainer.querySelectorAll('.card')).indexOf(div)+1;
    if(!ev.summary){alert(`事件 ${idx} 标题为空！`); return;}
    alert(buildSingleEventICS(ev));
  };

  eventsContainer.appendChild(div);
  refreshEventNumbers();
  return div;
}

function readEventFromCard(card){
  const uid=card.querySelector('.uid').value.trim();
  const summary=card.querySelector('.summary').value.trim();
  const description=card.querySelector('.description').value.trim();
  const dtstartRaw=card.querySelector('.dtstart').value;
  const dtendRaw=card.querySelector('.dtend').value;
  const rrule=card.querySelector('.rruleCustom').value.trim();
  const dtstart=dtstartRaw?dtstartRaw.replace(/-/g,''):'';
  const dtend=dtendRaw?dtendRaw.replace(/-/g,''):'';
  return {uid,summary,description,allDay:true,dtstart,dtend,rrule};
}

function buildSingleEventICS(ev){
  const lines=['BEGIN:VEVENT'];
  lines.push(`UID:${ev.uid||genUID()}`);
  lines.push(`DTSTAMP:${makeDTStampUTC(new Date())}`);
  lines.push(`SUMMARY:${escapeText(ev.summary)}`);
  if(ev.dtstart) lines.push(`DTSTART;VALUE=DATE:${ev.dtstart}`);
  if(ev.dtend) lines.push(`DTEND;VALUE=DATE:${ev.dtend}`);
  if(ev.rrule) lines.push(`RRULE:${ev.rrule}`);
  if(ev.description) lines.push(`DESCRIPTION:${escapeText(ev.description)}`);
  lines.push('END:VEVENT');
  return lines.map(foldLine).join('\r\n');
}

function buildCalendarICS(){
  const calName=document.getElementById('calName').value||'我的订阅日历';
  const tz=document.getElementById('tz').value||Intl.DateTimeFormat().resolvedOptions().timeZone||'';
  document.getElementById('tz').value=tz;
  const prodid=document.getElementById('prodid').value||'-//0515364.xyz//My Calendar//CN';
  const header=['BEGIN:VCALENDAR',`PRODID:${prodid}`,'VERSION:2.0','CALSCALE:GREGORIAN','METHOD:PUBLISH',`X-WR-CALNAME:${escapeText(calName)}`,`X-WR-TIMEZONE:${tz}`];
  const eventCards=Array.from(document.querySelectorAll('#events .card'));
  if(eventCards.length===0){createEventCard(); return '';}
  refreshEventNumbers();
  for(let i=0;i<eventCards.length;i++){
    const summary = eventCards[i].querySelector('.summary').value.trim();
    if(!summary){alert(`事件 ${i+1} 标题为空！`); return '';}
  }
  const events=eventCards.map(c=>buildSingleEventICS(readEventFromCard(c)));
  return header.concat(events).concat(['END:VCALENDAR']).join('\r\n')+'\r\n';
}

// 按钮事件
document.getElementById('addEventBtn').onclick=()=>createEventCard();
document.getElementById('clearEvents').onclick=()=>{if(confirm('确定清空吗？')){eventsContainer.innerHTML='';createEventCard();}};

document.getElementById('generateBtn').onclick=()=>{
  const ics=buildCalendarICS();
  if(!ics) return;
  document.getElementById('preview').textContent=ics;
};
document.getElementById('copyBtn').onclick=async()=>{
  const txt=document.getElementById('preview').textContent;
  if(!txt||txt.startsWith('//')){alert('请先生成 .ics');return;}
  try{await navigator.clipboard.writeText(txt);alert('已复制到剪贴板');}catch(e){alert('复制失败');}
};
document.getElementById('downloadBtn').onclick=()=>{
  const ics=document.getElementById('preview').textContent;
  if(!ics||ics.startsWith('//')){alert('请先生成 .ics');return;}
  const blob=new Blob([ics],{type:'text/calendar;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='calendar.ics';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
};

// 初始化
createEventCard();
</script>
</body>
</html>