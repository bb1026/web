<!doctype html>
<html lang="zh-CN">
   <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
      <title>ICS äº‹ä»¶ç”Ÿæˆå™¨ - 0515364.xyz</title>
      <!-- å¼•å…¥ Font Awesome -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
      <style>
         :root{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
         body{margin:0;padding:20px;background:#f6f7fb;color:#111;box-sizing:border-box;min-height:100vh;display:flex;flex-direction:column;gap:16px}
         h1{margin:0;font-size:1.25rem}
         .container{max-width:900px;margin:0 auto;width:100%}
         .card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 1px 6px rgba(20,20,40,0.06);margin-bottom:12px}
         label{display:block;font-size:0.9rem;margin-bottom:6px;color:#333;font-weight:500;}
         .card .event-header + label,
         .card label{
         color:#2563eb;
         font-weight:600;
         margin-top:6px;
         margin-bottom:4px;
         font-size:0.95rem;
         }
         input[type="text"], input[type="date"], input[type="time"], select, textarea{
         width:100%;padding:8px;border:1px solid #e2e6ef;border-radius:6px;font-size:0.95rem;box-sizing:border-box;
         }
         .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
         button{padding:10px 14px;border:0;border-radius:8px;background:#2563eb;color:#fff;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:all 0.2s;}
         button.secondary{background:#6b7280}
         button.small{padding:6px 10px;font-size:0.9rem}
         button:hover{opacity:0.85;transform:translateY(-1px);}
         .events-list{display:flex;flex-direction:column;gap:8px}
         .event-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
         .preview{white-space:pre;overflow:auto;max-height:360px;padding:12px;background:#0b1220;color:#e6eef8;font-family:monospace;border-radius:8px}
         .meta-row{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
         .muted{color:#6b7280;font-size:0.9rem}
         .rruleCustom{min-width:300px;font-family:monospace;}
         .date-block{margin-top:8px}
         @media (max-width:640px){
         .row{flex-direction:column}
         .event-header{flex-direction:column;align-items:flex-start}
         }
         .dialog-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;justify-content:center;align-items:center;z-index:1000;}
         .dialog-box{background:#fff;border-radius:10px;padding:16px;max-width:600px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.25);}
         .dialog-box pre{white-space:pre-wrap;background:#0b1220;color:#e6eef8;padding:12px;border-radius:8px;max-height:300px;overflow:auto;font-family:monospace;}
         .dialog-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
         .uid-status{display:flex;align-items:center;gap:6px;margin-top:4px;font-size:0.8rem;}
         .uid-status.auto{color:#10b981;}
         .uid-status.manual{color:#f59e0b;}
         .notification{position:fixed;top:20px;right:20px;background:#fff;border-radius:8px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,0.15);display:flex;align-items:center;gap:12px;z-index:10000;transform:translateX(100%);opacity:0;transition:all 0.3s ease;max-width:320px;}
         .notification.show{transform:translateX(0);opacity:1;}
         .notification.success{border-left:4px solid #10b981;}
         .notification.error{border-left:4px solid #ef4444;}
         .notification-icon{font-size:1.2rem;flex-shrink:0;}
         .notification.success .notification-icon{color:#10b981;}
         .notification.error .notification-icon{color:#ef4444;}
         .notification-content{flex:1;}
         .notification-title{font-weight:600;margin-bottom:4px;font-size:0.95rem;}
         .notification-message{font-size:0.85rem;color:#6b7280;}
         select{appearance:none;-webkit-appearance:none;-moz-appearance:none;padding:8px 12px;border:1px solid #e2e6ef;border-radius:6px;font-size:0.95rem;background:#fff url("data:image/svg+xml;utf8,
         <svg fill='%236b7280' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'>
            <path d='M7 10l5 5 5-5z'/>
         </svg>
         ") no-repeat right 10px center;background-size:16px 16px;cursor:pointer;transition:border-color 0.2s, box-shadow 0.2s;}
         select:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,0.2);}
         select:disabled{background-color:#f3f4f6;color:#9ca3af;cursor:not-allowed;}
      </style>
   </head>
   <body>
      <div class="container">
         <h1 style="display:flex;align-items:center;gap:12px;">
            <i class="fa-solid fa-calendar-plus"></i> ICS äº‹ä»¶ç”Ÿæˆå™¨
            <a href="calendar.html" style="margin-left:auto;font-size:0.9rem;color:#2563eb;text-decoration:none;display:flex;align-items:center;gap:4px;">
            <i class="fa-solid fa-calendar-days"></i> è®¢é˜…æ—¥å†
            </a>
         </h1>
         <div class="card">
            <label><i class="fa-solid fa-book"></i> æ—¥å†åç§°ï¼ˆX-WR-CALNAMEï¼‰</label>
            <input id="calName" type="text" value="æˆ‘çš„æ—¥å†" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„æ—¥å†">
            <label><i class="fa-solid fa-globe"></i> æ—¶åŒº (X-WR-TIMEZONE)
            <button id="refreshTz" class="small secondary" style="margin-left:8px;background:#ef4444;">
            <i class="fa-solid fa-rotate"></i> é‡ç½®
            </button>
            </label>
            <input id="tz" type="text" placeholder="ä¾‹å¦‚ï¼šAsia/Shanghai">
            <label><i class="fa-solid fa-code"></i> PRODID</label>
            <input id="prodid" type="text" value="-//0515364.xyz//My Calendar//CN">
         </div>
         <div class="card">
            <strong><i class="fa-solid fa-list"></i> äº‹ä»¶åˆ—è¡¨</strong>
            <div id="events" class="events-list" style="margin-top:12px"></div>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
               <button id="addEventBtn" class="small"><i class="fa-solid fa-plus"></i> æ·»åŠ äº‹ä»¶</button>
               <button id="clearEvents" class="small secondary"><i class="fa-solid fa-trash"></i> æ¸…ç©ºæ‰€æœ‰</button>
            </div>
            <div class="muted" style="margin-top:8px"><i class="fa-solid fa-circle-info"></i> è¯´æ˜ï¼š<br>
               â€¢ UID å¯ç•™ç©ºï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆæ‹¼éŸ³æ ¼å¼çš„UIDï¼›<br>
               â€¢ DTSTAMP è‡ªåŠ¨å¡«å†™ä¸ºå½“å‰æœ¬åœ°æ—¶é—´ï¼›<br>
               â€¢ é»˜è®¤å…¨å¤©äº‹ä»¶ï¼Œæ— æ³•æ·»åŠ æ—¶é—´ï¼›<br>
               â€¢ ä¿®æ”¹é‡å¤è§„åˆ™è¯·æŸ¥çœ‹è§„åˆ™ä»‹ç»ã€‚
            </div>
         </div>
         <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="generateBtn"><i class="fa-solid fa-eye"></i> ç”Ÿæˆ .ics å¹¶é¢„è§ˆ</button>
            <button id="copyBtn" class="secondary"><i class="fa-solid fa-copy"></i> å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
            <button id="downloadBtn" class="secondary"><i class="fa-solid fa-download"></i> ä¸‹è½½ .ics</button>
         </div>
         <div class="card">
            <label><i class="fa-solid fa-code"></i> é¢„è§ˆ (.ics)</label>
            <div id="preview" class="preview">// ç‚¹å‡»"ç”Ÿæˆ .ics å¹¶é¢„è§ˆ"æŸ¥çœ‹ç»“æœ</div>
         </div>
      </div>
      <script>
         // æ˜¾ç¤ºé€šçŸ¥å‡½æ•°
         function showNotification(type, title, message, duration = 3000) {
           const notification = document.createElement('div');
           notification.className = `notification ${type}`;
           
           let iconClass = 'fa-circle-info';
           if (type === 'success') iconClass = 'fa-circle-check';
           if (type === 'error') iconClass = 'fa-circle-exclamation';
           
           notification.innerHTML = `
             <div class="notification-icon">
               <i class="fa-solid ${iconClass}"></i>
             </div>
             <div class="notification-content">
               <div class="notification-title">${title}</div>
               <div class="notification-message">${message}</div>
             </div>
           `;
           
           document.body.appendChild(notification);
           
           // è§¦å‘åŠ¨ç”»
           setTimeout(() => notification.classList.add('show'), 10);
           
           // è‡ªåŠ¨éšè—
           setTimeout(() => {
             notification.classList.remove('show');
             setTimeout(() => notification.remove(), 300);
           }, duration);
           
           return notification;
         }
         
         // æ—¶åŒºé»˜è®¤å€¼
         function setDefaultTimezone(){
           const tzInput = document.getElementById('tz');
           tzInput.value = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Asia/Shanghai';
         }
         window.addEventListener('DOMContentLoaded', setDefaultTimezone);
         document.getElementById('refreshTz').onclick = setDefaultTimezone;
         
         function makeDTStampLocal(date=new Date()){
           const yyyy = date.getFullYear();
           const mm = String(date.getMonth()+1).padStart(2,'0');
           const dd = String(date.getDate()).padStart(2,'0');
           const hh = String(date.getHours()).padStart(2,'0');
           const mi = String(date.getMinutes()).padStart(2,'0');
           const ss = String(date.getSeconds()).padStart(2,'0');
           return `${yyyy}${mm}${dd}T${hh}${mi}${ss}`;
         }
         
         // UID è‡ªåŠ¨å¢åŠ é»˜è®¤åç¼€
         function formatUID(uid){
           uid = uid.trim();
           if(!uid) return '';
           return uid.includes('@') ? uid : `${uid}@0515364.xyz`;
         }
         
         function genUID(base){
           const rand=Math.random().toString(36).slice(2,10);
           const now=new Date().getTime();
           const host=(base && base.includes('@')) ? base.split('@').pop() : '0515364.xyz';
           return `${now}-${rand}@${host}`;
         }
         
         // ä¸­æ–‡è½¬æ‹¼éŸ³å‡½æ•°ï¼ˆé€å­—è½¬æ¢ï¼‰
         function convertToPinyin(text) {
           if (!text) return '';
           
           // å¸¸è§æ±‰å­—æ‹¼éŸ³æ˜ å°„è¡¨ï¼ˆæ¯ä¸ªå­—ç‹¬ç«‹ï¼‰
           const pinyinMap = {
             'æ•™': 'jiao', 'å¸ˆ': 'shi', 'èŠ‚': 'jie', 'å…ƒ': 'yuan', 
             'æ—¦': 'dan', 'æ˜¥': 'chun', 'æ¸…': 'qing', 'æ˜': 'ming', 
             'åŠ³': 'lao', 'åŠ¨': 'dong', 'ç«¯': 'duan', 'åˆ': 'wu', 
             'ä¸­': 'zhong', 'ç§‹': 'qiu', 'å›½': 'guo', 'åº†': 'qing', 
             'è€¶': 'ye', 'ç¨£': 'su', 'å—': 'shou', 'éš¾': 'nan', 
             'æ—¥': 'ri', 'å«': 'wei', 'å¡': 'sai', 'å± ': 'tu', 
             'å¦–': 'yao', 'åœ£': 'sheng', 'è¯': 'dan', 'å¼€': 'kai', 
             'æ–‹': 'zhai', 'å“ˆ': 'ha', 'èŠ': 'zhi', 'æ–°': 'xin', 'å†œ': 'nong', 'å†': 'li', 
             'å¹´': 'nian', 'é™…': 'ji', 'äºº': 'ren', 'æ°‘': 'min', 
             'å…±': 'gong', 'å’Œ': 'he' , 'æ¤': 'zhi', 'æ ‘': 'shu' ,'å„¿': 'er' ,'ç«¥': 'tong', 'å»º': 'jian', 'å…š': 'dang', 'å†›': 'jun', 'é’': 'qing', 'æŠ¤': 'hu', 'å£«': 'shi', 'å…‰': 'guang', 'æ£': 'gun', 'å¤•': 'xi', 'é‡': 'chong', 'é˜³': 'yang', 'è…Š': 'la', 'ä¸€': 'yi', 'äºŒ': 'er', 'ä¸‰': 'san', 'å››': 'si', 'äº”': 'wu', 'å…­': 'liu', 'ä¸ƒ': 'qi', 'å…«': 'ba', 'ä¹': 'jiu', 'å': 'shi', 'é›¶': 'ling'};
           
           let result = '';
           for (let i = 0; i < text.length; i++) {
             const char = text[i];
             if (pinyinMap[char]) {
               result += pinyinMap[char];
             } else if (/[a-zA-Z0-9]/.test(char)) {
               result += char;
             }
             // å¿½ç•¥ä¸åœ¨æ˜ å°„è¡¨ä¸­çš„ä¸­æ–‡å­—ç¬¦
           }
           
           return result;
         }
         
         function foldLine(line){const max=75;if(line.length<=max)return line;let out='',pos=0;while(pos<line.length){if(pos===0){out+=line.slice(pos,pos+max);}else{out+='\r\n '+line.slice(pos,pos+max);}pos+=max;}return out;}
         function escapeText(s){return(s||'').replace(/\\/g,'\\\\').replace(/;/g,'\\;').replace(/,/g,'\\,').replace(/\n/g,'\\n');}
         
         const eventsContainer=document.getElementById('events');
         
         // ä¿å­˜æ‰“å¼€å¼¹çª—å‰çš„æ»šåŠ¨ä½ç½®ï¼ˆç”¨äºæ¢å¤ï¼‰
         let _savedScrollY = null;
         function disableBodyScroll(){
           if (_savedScrollY !== null) return; // å·²é”å®š
           _savedScrollY = window.scrollY || document.documentElement.scrollTop || 0;
           // å›ºå®š body ä½ç½®ï¼Œé˜²æ­¢èƒŒæ™¯æ»šåŠ¨ï¼ŒåŒæ—¶ä¿æŒè§†è§‰ä½ç½®ä¸å˜
           document.body.style.position = 'fixed';
           document.body.style.top = `-${_savedScrollY}px`;
           document.body.style.left = '0';
           document.body.style.right = '0';
         }
         function enableBodyScroll(){
           if (_savedScrollY === null) return;
           // æ¢å¤ body æ ·å¼å¹¶æ»šåŠ¨å›ä¹‹å‰ä½ç½®
           document.body.style.position = '';
           document.body.style.top = '';
           document.body.style.left = '';
           document.body.style.right = '';
           const y = _savedScrollY;
           _savedScrollY = null;
           window.scrollTo(0, y);
         }
         
         function refreshEventNumbers(){
           const cards = eventsContainer.querySelectorAll('.card');
           // é¢„è®¾ä¸€ç»„ Font Awesome å›¾æ ‡
           const icons = [
             "fa-star", "fa-heart", "fa-gift", "fa-bell", "fa-american-sign-language-interpreting", "fa-apple-alt", "fa-asterisk", "fa-flag", "fa-moon", "fa-sun", "fa-cake-candles", "fa-music", "fa-seedling", "fa-tree", "fa-smile", "fa-award", "fa-bahai", "fa-basketball-ball"
           ];
         
           cards.forEach((card, i)=>{
             const strong = card.querySelector('.event-header strong');
             // å¦‚æœè¯¥å¡ç‰‡è¿˜æ²¡æœ‰åˆ†é…è¿‡å›¾æ ‡ï¼Œå°±éšæœºé€‰ä¸€ä¸ª
             if (!card.dataset.icon) {
               const randomIcon = icons[Math.floor(Math.random() * icons.length)];
               card.dataset.icon = randomIcon;
             }
             const iconClass = card.dataset.icon;
             strong.innerHTML = `<i class="fa-solid ${iconClass}"></i> äº‹ä»¶ #${i+1}`;
           });
         }
         
         function createDialog(title, content, withCopy=false){
           const backdrop=document.createElement('div');
           backdrop.className='dialog-backdrop';
           const box=document.createElement('div');
           box.className='dialog-box';
           box.innerHTML=`<h3 style="margin-top:0;font-size:1rem">${title}</h3>`;
           if(typeof content==='string'){
             box.innerHTML+=`<pre>${content}</pre>`;
           }else{
             box.appendChild(content);
           }
           const actions=document.createElement('div');
           actions.className='dialog-actions';
           if(withCopy){
             const copyBtn=document.createElement('button');
             copyBtn.textContent='å¤åˆ¶';
             copyBtn.onclick=async()=>{
               try{
                 // å¦‚æœ content æ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥å¤åˆ¶ï¼›å¦åˆ™å°è¯•å¤åˆ¶ innerText
                 const toCopy = (typeof content === 'string') ? content : (content.innerText || content.textContent || '');
                 await navigator.clipboard.writeText(toCopy);
                 showNotification('success', 'å·²å¤åˆ¶', 'å†…å®¹å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿');
               }catch(e){
                 showNotification('error', 'å¤åˆ¶å¤±è´¥', 'æ— æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
               }
             };
             actions.appendChild(copyBtn);
           }
           const closeBtn=document.createElement('button');
           closeBtn.textContent='å…³é—­';
           closeBtn.onclick=()=>{
             backdrop.remove();
             enableBodyScroll();
           };
           actions.appendChild(closeBtn);
           box.appendChild(actions);
           backdrop.appendChild(box);
         
           // é˜»æ­¢ backdrop æœ¬èº«çš„è§¦æ‘¸/æ»šåŠ¨ç©¿é€ï¼ˆå¢åŠ é¢å¤–ä¿æŠ¤ï¼‰
           backdrop.addEventListener('touchmove', function(e){ e.preventDefault(); }, {passive:false});
         
           document.body.appendChild(backdrop);
         
           // æ‰“å¼€å¼¹çª—æ—¶ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
           disableBodyScroll();
         }
         
         function createEventCard(data){
           const div=document.createElement('div');
           div.className='card';
           const today=new Date();
           const yyyy=today.getFullYear(),mm=String(today.getMonth()+1).padStart(2,'0'),dd=String(today.getDate()).padStart(2,'0');
           const todayDate=`${yyyy}-${mm}-${dd}`;
         
           div.innerHTML=`
             <div class="event-header">
               <strong>äº‹ä»¶</strong>
               <div style="display:flex;gap:6px">
                 <button class="removeBtn secondary small"><i class="fa-solid fa-trash"></i> åˆ é™¤</button>
                 <button class="clearBtn secondary small"><i class="fa-solid fa-eraser"></i> æ¸…ç©º</button>
               </div>
             </div>
             <label><i class="fa-solid fa-fingerprint"></i> UIDï¼ˆå¯ç•™ç©ºéšæœºç”Ÿæˆï¼‰</label>
             <input class="uid" type="text" value="${data?.uid||''}" placeholder="ä¾‹å¦‚ï¼šnewyear@0515364.xyz">
             <div class="uid-status ${data?.uid ? 'manual' : 'auto'}">
               <i class="fa-solid ${data?.uid ? 'fa-pen' : 'fa-bolt'}"></i> 
               <span>${data?.uid ? 'æ‰‹åŠ¨è¾“å…¥UID' : 'è‡ªåŠ¨ç”ŸæˆUID'}</span>
             </div>
             <label><i class="fa-solid fa-heading"></i> æ ‡é¢˜ï¼ˆSUMMARYï¼‰</label>
             <input class="summary" type="text" value="${data?.summary||''}" placeholder="å…ƒæ—¦">
             <label><i class="fa-solid fa-align-left"></i> è¯´æ˜ï¼ˆDESCRIPTIONï¼Œå¯é€‰ï¼‰</label>
             <textarea class="description" rows="3" placeholder="å…ƒæ—¦: æ–°å¹´ç¬¬ä¸€å¤©ï¼ğŸ‰">${data?.description||''}</textarea>
             <div class="date-row" style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap;">
               <div style="flex:1;display:flex;flex-direction:column;">
                 <label><i class="fa-solid fa-calendar-day"></i> å¼€å§‹ (DTSTART)</label>
                 <input class="dtstart" type="date" value="${data?.dtstart ? data.dtstart : todayDate}">
               </div>
               <div style="flex:1;display:flex;flex-direction:column;">
                 <label><i class="fa-solid fa-calendar-check"></i> ç»“æŸ (DTEND)</label>
                 <input class="dtend" type="date" value="${data?.dtend ? data.dtend : todayDate}">
               </div>
             </div>
             <div style="margin-top:8px">
               <label><input type="checkbox" class="hasTime"><i class="fa-solid fa-clock"></i> æ·»åŠ æ—¶é—´</label>
               <div class="time-row" style="display:none;gap:12px;margin-top:6px;flex-wrap:wrap;">
                 <div style="flex:1;display:flex;flex-direction:column;">
                   <label>å¼€å§‹æ—¶é—´</label>
                   <input class="tstart" type="time" value="00:00">
                 </div>
                 <div style="flex:1;display:flex;flex-direction:column;">
                   <label>ç»“æŸæ—¶é—´</label>
                   <input class="tend" type="time" value="00:00">
                 </div>
               </div>
             </div>
             <label><i class="fa-solid fa-redo"></i>é‡å¤è§„åˆ™ (RRULE)</label>
             <select class="rrulePreset">
               <option value="">æ— </option>
               <option value="YEARLY">æ¯å¹´åŒä¸€å¤©</option>
               <option value="YEARLY_MONTHDAY">æ¯å¹´åŒæœˆåŒæ—¥</option>
               <option value="MONTHLY">æ¯æœˆåŒä¸€å¤©</option>
               <option value="WEEKLY">æ¯å‘¨æŸå¤©</option>
               <option value="FATHER_DAY">çˆ¶äº²èŠ‚ï¼ˆ6æœˆç¬¬3ä¸ªå‘¨æ—¥ï¼‰</option>
               <option value="YEARLY_SPECIAL">æ¯äº²èŠ‚ï¼ˆ5æœˆç¬¬2ä¸ªå‘¨æ—¥ï¼‰</option>
             </select>
             <input class="rruleCustom" value="${data?.rrule||''}">
             <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
               <button class="fillSample small secondary"><i class="fa-solid fa-magic"></i> å¡«ç¤ºä¾‹</button>
               <button class="ruleInfoBtn small secondary"><i class="fa-solid fa-circle-info"></i> è§„åˆ™ä»‹ç»</button>
               <button class="previewEventBtn small"><i class="fa-solid fa-eye"></i> é¢„è§ˆäº‹ä»¶</button>
             </div>
           `;
         
           const hasTime=div.querySelector('.hasTime');
           const timeRow=div.querySelector('.time-row');
           hasTime.addEventListener('change',()=>{timeRow.style.display=hasTime.checked?'flex':'none';});
         
           const dtstartInput=div.querySelector('.dtstart');
           const dtendInput=div.querySelector('.dtend');
           const summaryInput = div.querySelector('.summary');
           const uidInput = div.querySelector('.uid');
           const rruleSel = div.querySelector('.rrulePreset');
           const rruleCustom = div.querySelector('.rruleCustom');
         
           // è®¾ç½®é¢„è®¾çš„é‡å¤è§„åˆ™
           if (data?.rrule) {
             if (data.rrule === 'FREQ=YEARLY') {
               rruleSel.value = 'YEARLY';
             } else if (data.rrule.includes('BYMONTHDAY')) {
               rruleSel.value = 'YEARLY_MONTHDAY';
             } else if (data.rrule.includes('FREQ=MONTHLY')) {
               rruleSel.value = 'MONTHLY';
             } else if (data.rrule.includes('FREQ=WEEKLY')) {
               rruleSel.value = 'WEEKLY';
             } else if (data.rrule.includes('FATHER_DAY')) {
               rruleSel.value = 'FATHER_DAY';
             } else if (data.rrule.includes('YEARLY_SPECIAL')) {
               rruleSel.value = 'YEARLY_SPECIAL';
             }
             rruleCustom.value = data.rrule;
           }
         
         const uidStatus = div.querySelector('.uid-status');
         
           // ç›‘å¬ UID è¾“å…¥æ¡†ï¼Œåˆ‡æ¢çŠ¶æ€
           uidInput.addEventListener('input', function() {
             if (this.value.trim()) {
               uidStatus.className = 'uid-status manual';
               uidStatus.innerHTML = `<i class="fa-solid fa-pen"></i> <span>æ‰‹åŠ¨è¾“å…¥UID</span>`;
             } else {
               uidStatus.className = 'uid-status auto';
               uidStatus.innerHTML = `<i class="fa-solid fa-bolt"></i> <span>è‡ªåŠ¨ç”ŸæˆUID</span>`;
             }
           });
         
           // å¦‚æœæä¾›äº†æ•°æ®ï¼Œè‡ªåŠ¨ç”ŸæˆUID
           if (data?.summary) {
             const pinyinUid = convertToPinyin(data.summary);
             if (pinyinUid) {
               uidInput.value = formatUID(pinyinUid);
             }
           }
         
           // ç›‘å¬æ ‡é¢˜è¾“å…¥å˜åŒ–ï¼Œè‡ªåŠ¨ç”Ÿæˆæ‹¼éŸ³UID
           summaryInput.addEventListener('input', function() {
           const summaryText = this.value.trim();
         
           // åªæœ‰å½“ UID çŠ¶æ€ä¸ºè‡ªåŠ¨ç”Ÿæˆæ—¶ï¼Œæ‰æ›´æ–° UID
           if (uidStatus.classList.contains('auto')) {
             if (summaryText) {
               const pinyinUid = convertToPinyin(summaryText);
               if (pinyinUid) {
                 uidInput.value = formatUID(pinyinUid);
               } else {
                 uidInput.value = '';
               }
             } else {
               uidInput.value = '';
             }
           }
         });
         
           dtstartInput.onchange=dtendInput.onchange=()=>{
             const start = new Date(dtstartInput.value);
             const end = new Date(dtendInput.value);
             if(end<start) dtendInput.value = dtstartInput.value;
           };
         
           function updateRRULE(){
             const v=dtstartInput.value;
             if(!v){rruleCustom.value=''; return;}
             const d=new Date(v);
             switch(rruleSel.value){
               case 'YEARLY': rruleCustom.value='FREQ=YEARLY'; break;
               case 'YEARLY_MONTHDAY': rruleCustom.value=`FREQ=YEARLY;BYMONTH=${d.getMonth()+1};BYMONTHDAY=${d.getDate()}`; break;
               case 'MONTHLY': rruleCustom.value=`FREQ=MONTHLY;BYMONTHDAY=${d.getDate()}`; break;
               case 'WEEKLY': rruleCustom.value=`FREQ=WEEKLY;BYDAY=MO`; break;
               case 'YEARLY_SPECIAL': rruleCustom.value='FREQ=YEARLY;BYMONTH=5;BYDAY=2SU'; break;
               case 'FATHER_DAY': rruleCustom.value='FREQ=YEARLY;BYMONTH=6;BYDAY=3SU'; break;
               default: rruleCustom.value=''; break;
             }
           }
           dtstartInput.onchange=()=>{updateRRULE(); dtendInput.onchange();}
           rruleSel.onchange=updateRRULE;
         
           div.querySelector('.removeBtn').onclick=()=>{
             div.remove();
             refreshEventNumbers();
           };
           div.querySelector('.clearBtn').onclick=()=>{
             div.querySelector('.uid').value='';
             div.querySelector('.summary').value='';
             div.querySelector('.description').value='';
             dtstartInput.value=todayDate;
             dtendInput.value=todayDate;
             rruleSel.value='';
             rruleCustom.value='';
           };
         
           div.querySelector('.fillSample').onclick=()=>{
           div.querySelector('.summary').value='å…ƒæ—¦';
           div.querySelector('.description').value = `å…ƒæ—¦ï¼šæ–°å¹´ç¬¬ä¸€å¤©ï¼Œæ–°å¹´å¿«ä¹ï¼ğŸ‰
ä¸­å›½çš„å…ƒæ—¦ï¼Œæ®ä¼ è¯´èµ·äºä¸‰çš‡äº”å¸ä¹‹ä¸€çš„é¢›é¡¼ï¼Œè·ä»Šå·²æœ‰3000å¤šå¹´çš„å†å²ã€‚
â€œå…ƒæ—¦â€ä¸€è¯æœ€æ—©å‡ºç°äºã€Šæ™‹ä¹¦ã€‹ï¼šâ€œé¢›å¸ä»¥å­Ÿå¤æ­£æœˆä¸ºå…ƒï¼Œå…¶å®æ­£æœ”å…ƒæ—¦ä¹‹æ˜¥â€çš„è¯—ä¸­ã€‚
å—åŒ—æœæ—¶ï¼Œå—æœè§å­äº‘çš„ã€Šä»‹é›…ã€‹è¯—ä¸­ä¹Ÿæœ‰â€œå››å­£æ–°å…ƒæ—¦ï¼Œä¸‡å¯¿åˆæ˜¥æœâ€çš„è®°è½½ã€‚`;
           const thisYear = new Date().getFullYear();
           dtstartInput.value=`${thisYear}-01-01`;
           dtendInput.value=`${thisYear}-01-01`;
           rruleSel.value='YEARLY';
           rruleCustom.value='FREQ=YEARLY';
           // è‡ªåŠ¨ç”Ÿæˆæ‹¼éŸ³UID
           const pinyinUid = convertToPinyin('å…ƒæ—¦');
           if (pinyinUid) {
             uidInput.value = formatUID(pinyinUid);
           }
         
           const hasTime = div.querySelector('.hasTime');
           const timeRow = div.querySelector('.time-row');
           const tstartInput = div.querySelector('.tstart');
           const tendInput = div.querySelector('.tend');
           hasTime.checked = true;
           timeRow.style.display = 'flex';
           tstartInput.value = "00:00";
           tendInput.value = "23:59";
         };
         
           div.querySelector('.ruleInfoBtn').onclick=()=>{
             const text=`
         â€¢ æ¯å¹´åŒä¸€å¤©ï¼šFREQ=YEARLY
         
         â€¢ æ¯å¹´åŒæœˆåŒæ—¥ï¼šFREQ=YEARLY;BYMONTH=9;BYMONTHDAY=10
         
         â€¢ æ¯æœˆåŒä¸€å¤©ï¼šFREQ=MONTHLY;BYMONTHDAY=15
         
         â€¢ æ¯å‘¨æŸå¤©ï¼šFREQ=WEEKLY;BYDAY=MO
         "MO" / "TU" / "WE" / "TH" / "FR" / "SA" / "SU"
         
         â€¢ æ¯äº²èŠ‚ï¼šFREQ=YEARLY;BYMONTH=5;BYDAY=2SU
         
         â€¢ çˆ¶äº²èŠ‚ï¼šFREQ=YEARLY;BYMONTH=6;BYDAY=3SU
         `;
             createDialog('RRULE è§„åˆ™è¯´æ˜ï¼š', text, false);
           };
         
           div.querySelector('.previewEventBtn').onclick = () => {
           refreshEventNumbers();
           const ev = readEventFromCard(div);
           const idx = Array.from(eventsContainer.querySelectorAll('.card')).indexOf(div) + 1;
           if (!ev.summary) {
             showNotification('error', 'é¢„è§ˆå¤±è´¥', `äº‹ä»¶ ${idx} æ ‡é¢˜ä¸ºç©ºï¼`);
             return;
           }
           let text = buildSingleEventICS(ev);
           
           // é¢„è§ˆæ—¶æŠŠ \n è½¬æˆçœŸæ­£æ¢è¡Œ
           text = text.replace(/\\n/g, '\n');
         
           createDialog('äº‹ä»¶ ICS é¢„è§ˆ', text, true);
         };
         
           eventsContainer.appendChild(div);
           refreshEventNumbers();
           return div;
         }
         
         function readEventFromCard(card){
           const uid=card.querySelector('.uid').value.trim();
           const summary=card.querySelector('.summary').value.trim();
           const description=card.querySelector('.description').value.trim();
           const dtstartRaw=card.querySelector('.dtstart').value;
           const dtendRaw=card.querySelector('.dtend').value;
           const hasTime=card.querySelector('.hasTime').checked;
           const tstart=card.querySelector('.tstart')?.value||"00:00";
           const tend=card.querySelector('.tend')?.value||"00:00";
           let dtstart="",dtend="";
           if(dtstartRaw){
             dtstart=hasTime?dtstartRaw.replace(/-/g,'')+'T'+tstart.replace(':','')+'00':dtstartRaw.replace(/-/g,'');
           }
           if(dtendRaw){
             dtend=hasTime?dtendRaw.replace(/-/g,'')+'T'+tend.replace(':','')+'00':dtendRaw.replace(/-/g,'');
           }
           return {uid,summary,description,allDay:!hasTime,dtstart,dtend};
         }
         
         function buildSingleEventICS(ev){
           const lines=['BEGIN:VEVENT'];
           lines.push(`UID:${ev.uid||genUID()}`);
           lines.push(`DTSTAMP:${makeDTStampLocal(new Date())}`);
           lines.push(`SUMMARY:${escapeText(ev.summary)}`);
           if(ev.allDay){
             lines.push(`DTSTART;VALUE=DATE:${ev.dtstart}`);
             lines.push(`DTEND;VALUE=DATE:${ev.dtend}`);
           }else{
             lines.push(`DTSTART:${ev.dtstart}`);
             lines.push(`DTEND:${ev.dtend}`);
           }
           if(ev.description)lines.push(`DESCRIPTION:${escapeText(ev.description)}`);
           lines.push('END:VEVENT');
           return lines.join('\r\n');
         }
         
         function buildCalendarICS(){
           const calName=document.getElementById('calName').value||'æˆ‘çš„è®¢é˜…æ—¥å†';
           const tz=document.getElementById('tz').value||Intl.DateTimeFormat().resolvedOptions().timeZone||'';
           document.getElementById('tz').value=tz;
           const prodid=document.getElementById('prodid').value||'-//0515364.xyz//My Calendar//CN';
           
           const header=[
             'BEGIN:VCALENDAR',
             `PRODID:${prodid}`,
             'VERSION:2.0',
             'CALSCALE:GREGORIAN',
             'METHOD:PUBLISH',
             `X-WR-CALNAME:${escapeText(calName)}`,
             `X-WR-TIMEZONE:${tz}`
           ];
           
           const eventCards=Array.from(document.querySelectorAll('#events .card'));
           if(eventCards.length===0){createEventCard(); return '';}
           refreshEventNumbers();
           for(let i=0;i<eventCards.length;i++){
             const summary = eventCards[i].querySelector('.summary').value.trim();
             if(!summary){showNotification('error', 'ç”Ÿæˆå¤±è´¥', `äº‹ä»¶ ${i+1} æ ‡é¢˜ä¸ºç©ºï¼`); return '';}
           }
         
           // æ¯ä¸ªäº‹ä»¶ä¹‹é—´åŠ ç©ºè¡Œï¼Œç¬¬ä¸€ä¸ªäº‹ä»¶å’Œä¸Šæ–¹åŠ ç©ºè¡Œï¼Œæœ€åä¸€ä¸ªäº‹ä»¶å’Œä¸‹æ–¹åŠ ç©ºè¡Œ
           const events = eventCards.map(c=>buildSingleEventICS(readEventFromCard(c))).join('\r\n\r\n');
         
           // å¤´éƒ¨å’Œäº‹ä»¶ä¹‹é—´åŠ ç©ºè¡Œï¼Œæœ€åå’Œ END:VCALENDAR ä¹‹é—´ä¹ŸåŠ ç©ºè¡Œ
           return header.join('\r\n') + '\r\n\r\n' + events + '\r\n\r\nEND:VCALENDAR\r\n';
         }
         
         // æŒ‰é’®äº‹ä»¶
         document.getElementById('addEventBtn').onclick=()=>createEventCard();
         document.getElementById('clearEvents').onclick=()=>{if(confirm('ç¡®å®šæ¸…ç©ºå—ï¼Ÿ')){eventsContainer.innerHTML='';createEventCard();}};
         
         document.getElementById('generateBtn').onclick=()=>{
           const ics=buildCalendarICS();
           if(!ics) return;
           document.getElementById('preview').textContent = ics.replace(/\\n/g, '\n');
           showNotification('success', 'ç”ŸæˆæˆåŠŸ', 'ICS å†…å®¹å·²ç”Ÿæˆï¼Œè¯·æŸ¥çœ‹é¢„è§ˆåŒºåŸŸ');
         };
         document.getElementById('copyBtn').onclick=async()=>{
           const text=document.getElementById('preview').textContent;
           if(text.startsWith('// ')){showNotification('error', 'å¤åˆ¶å¤±è´¥', 'è¯·å…ˆç”Ÿæˆ ICS å†…å®¹');return;}
           try{await navigator.clipboard.writeText(text);showNotification('success', 'å¤åˆ¶æˆåŠŸ', 'ICS å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');}catch(e){showNotification('error', 'å¤åˆ¶å¤±è´¥', 'æ— æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');}
         };
         document.getElementById('downloadBtn').onclick=()=>{
           const text=document.getElementById('preview').textContent;
           if(text.startsWith('// ')){showNotification('error', 'ä¸‹è½½å¤±è´¥', 'è¯·å…ˆç”Ÿæˆ ICS å†…å®¹');return;}
           const blob=new Blob([text],{type:'text/calendar;charset=utf-8'});
           const url=URL.createObjectURL(blob);
           const a=document.createElement('a');
           a.href=url;a.download='calendar.ics';
           a.click();
           URL.revokeObjectURL(url);
           showNotification('success', 'ä¸‹è½½æˆåŠŸ', 'ICS æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½');
         };
         
         // åˆå§‹åŒ–ä¸€ä¸ªäº‹ä»¶
         createEventCard();
      </script>
   </body>
</html>
