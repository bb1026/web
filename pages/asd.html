<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>公交数据同步 GitHub</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  body { font-family: Arial, sans-serif; padding: 10px; margin: 0; background: #f5f5f5; }
  h2 { text-align: center; margin-bottom: 20px; }
  .api-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
  .api-card { background: #fff; padding: 15px; border-radius: 8px; width: 250px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; }
  .api-card button { padding: 8px 12px; margin-top: 10px; cursor: pointer; border: none; border-radius: 5px; background: #007bff; color: #fff; font-size: 14px; display: flex; align-items: center; gap: 5px; transition: 0.3s; }
  .api-card button:hover { background: #0056b3; }
  .progress-wrapper { width: 100%; margin-top: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; height: 12px; }
  .progress-bar { height: 100%; width: 0; background: #28a745; transition: width 0.2s; }
  .update-time { margin-top:5px; font-size:12px; color:#666; }
  #status { margin-top: 20px; white-space: pre-wrap; text-align: center; }
  @media (max-width: 600px) { .api-card { width: 90%; } }
</style>
</head>
<body>

<h2><i class="fas fa-bus"></i> 公交数据同步 GitHub</h2>

<div class="api-container">
  <div class="api-card" data-key="busRoutes">
    <strong>Bus Routes</strong>
    <button class="download-btn"><i class="fas fa-download"></i> 下载 & 上传</button>
    <div class="progress-wrapper"><div class="progress-bar"></div></div>
    <div class="update-time">上次更新时间: 未知</div>
  </div>
  <div class="api-card" data-key="busServices">
    <strong>Bus Services</strong>
    <button class="download-btn"><i class="fas fa-download"></i> 下载 & 上传</button>
    <div class="progress-wrapper"><div class="progress-bar"></div></div>
    <div class="update-time">上次更新时间: 未知</div>
  </div>
  <div class="api-card" data-key="busStops">
    <strong>Bus Stops</strong>
    <button class="download-btn"><i class="fas fa-download"></i> 下载 & 上传</button>
    <div class="progress-wrapper"><div class="progress-bar"></div></div>
    <div class="update-time">上次更新时间: 未知</div>
  </div>
</div>

<div style="text-align:center; margin-top: 20px;">
  <button id="downloadAllBtn" style="padding:10px 15px; font-size:16px; border:none; border-radius:6px; background:#17a2b8; color:#fff; display:flex; align-items:center; gap:5px;">
    <i class="fas fa-download"></i> 全部下载 & 上传
  </button>
</div>

<div id="status"></div>

<script>
const GITHUB_TOKEN = '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';
const OWNER = 'bb1026';
const REPO = 'bus';
const FILE_PATH_PREFIX = 'js/';

const apiUrls = {
  busRoutes: "https://datamall2.mytransport.sg/ltaodataservice/BusRoutes?$skip=",
  busServices: "https://datamall2.mytransport.sg/ltaodataservice/BusServices?$skip=",
  busStops: "https://datamall2.mytransport.sg/ltaodataservice/BusStops?$skip="
};
const maxSkip = { busRoutes: 26000, busServices: 1000, busStops: 5500 };
const headers = { AccountKey: atob("WFhQZ2RyNVFTZGlGZUROaGdoR0dydz09"), Accept: "application/json" };

const statusDiv = document.getElementById('status');
function logStatus(msg) { statusDiv.innerText += msg + '\n'; }

async function fetchAllData(apiKey, progressCallback) {
  let allData = [];
  let skip = 0;
  const step = 500;
  while (skip <= maxSkip[apiKey]) {
    try {
      const url = apiUrls[apiKey] + skip;
      const res = await fetch(url, { headers });
      const json = await res.json();
      if (json.value) allData.push(...json.value);
      skip += step;
      if (progressCallback) progressCallback(Math.min(skip / maxSkip[apiKey],1));
    } catch (err) {
      logStatus(`下载 ${apiKey} 数据失败，skip=${skip}: ${err}`);
      skip += step; // 避免卡死
    }
  }
  return allData;
}

async function getFileSha(path) {
  try {
    const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`, {
      headers: { Authorization: `token ${GITHUB_TOKEN}` }
    });
    if (!res.ok) return null;
    const data = await res.json();
    return data.sha;
  } catch (e) {
    logStatus(`获取文件 SHA 失败 (${path}): ${e}`);
    return null;
  }
}

async function uploadToGitHub(path, content, progressCallback) {
  const sha = await getFileSha(path);
  try {
    const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`, {
      method: 'PUT',
      headers: { Authorization: `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: `自动更新 ${new Date().toLocaleString()}`, content: btoa(JSON.stringify(content,null,2)), sha })
    });
    if (!res.ok) {
      const result = await res.json();
      logStatus(`上传失败 (${path}): ${JSON.stringify(result)}`);
      return false;
    }
    if (progressCallback) progressCallback(1);
    return true;
  } catch (err) {
    logStatus(`上传失败 (${path}): ${err}`);
    return false;
  }
}

async function downloadAndUpload(key, progressBar, card) {
  progressBar.style.width = '0%';
  const data = await fetchAllData(key, p => progressBar.style.width = (p*50)+'%');
  const path = FILE_PATH_PREFIX + key + '.json';
  const ok = await uploadToGitHub(path, data, p => progressBar.style.width = (50 + p*50)+'%');
  if (ok) {
    progressBar.style.width = '100%';
    const timeDiv = card.querySelector('.update-time');
    timeDiv.innerText = '上次更新时间: ' + new Date().toLocaleString();
  }
  return ok;
}

// 单独下载按钮
document.querySelectorAll('.download-btn').forEach(btn=>{
  btn.addEventListener('click', async e=>{
    const card = e.target.closest('.api-card');
    const key = card.dataset.key;
    const bar = card.querySelector('.progress-bar');
    logStatus(`开始处理 ${key}...`);
    await downloadAndUpload(key, bar, card);
    logStatus(`${key} 完成`);
  });
});

// 全部下载按钮
document.getElementById('downloadAllBtn').addEventListener('click', async ()=>{
  const cards = document.querySelectorAll('.api-card');
  for (const card of cards) {
    const key = card.dataset.key;
    const bar = card.querySelector('.progress-bar');
    logStatus(`开始处理 ${key}...`);
    await downloadAndUpload(key, bar, card);
    logStatus(`${key} 完成`);
  }
  logStatus('全部完成');
});
</script>

</body>
</html>
