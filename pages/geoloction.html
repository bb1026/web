<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>定位</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
body { font-family: -apple-system, BlinkMacSystemFont, Arial; margin:0; padding:0; }
#output, #address { padding: 10px; font-size: 14px; white-space: pre-line; }
#address { color: #007bff; }
#map { height: 400px; width: 100%; margin-top: 5px; }
#output i, #address i { color: #007bff; margin-right: 5px; }

/* 弹窗 */
#modalOverlay {
  display: none;
  position: fixed; top:0; left:0; right:0; bottom:0;
  background-color: rgba(0,0,0,0.5); z-index: 9999;
}
#modalBox {
  position: absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  background-color:#fff; padding:20px 30px; border-radius:8px; text-align:center; max-width:80%;
}
#modalBox button { margin-top:15px; background:#007bff; color:#fff; padding:8px 14px; border-radius:6px; border:none; }

/* 按钮栏：放在地址下方、地图上方 */
.button-bar {
  display: flex; flex-wrap: nowrap; overflow-x: auto;
  border-top: 1px solid #ccc; border-bottom: 1px solid #ccc;
  background: #f8f9fa;
}
.button-bar button {
  flex: 1 0 auto;
  padding: 10px 6px;
  border: none;
  background: none;
  font-size: 14px;
  cursor: pointer;
}
.button-bar button i { margin-right: 5px; }
</style>
</head>
<body>

<div id="output"><i class="fa-solid fa-location-crosshairs"></i> 等待定位...</div>
<div id="address"><i class="fa-solid fa-house"></i> 地址: 未获取</div>

<!-- 按钮栏：地址下方 -->
<div class="button-bar">
  <button onclick="openGoogleMap()"><i class="fa-brands fa-google"></i> 谷歌</button>
  <button onclick="openAppleMap()"><i class="fa-brands fa-apple"></i> 苹果</button>
  <button onclick="openAmap()"><i class="fa-solid fa-location-dot"></i> 高德</button>
  <button onclick="openTencentMap()"><i class="fa-brands fa-qq"></i> 腾讯</button>
  <button onclick="openBaiduMap()"><i class="fa-solid fa-map"></i> 百度</button>
</div>

<div id="map"></div>

<!-- 弹窗 -->
<div id="modalOverlay">
  <div id="modalBox">
    <div id="modalMessage"></div>
    <button onclick="closeModal()">关闭</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let lastCoords = null;
let lastAddressTime = 0;
let map, marker;
let lastLatLng = null;

// 初始化地图
map = L.map('map').setView([0,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

// 弹窗
function showModal(msg) {
  document.getElementById('modalMessage').innerText = msg;
  document.getElementById('modalOverlay').style.display = 'block';
  document.body.style.overflow = 'hidden';
}
function closeModal() {
  document.getElementById('modalOverlay').style.display = 'none';
  document.body.style.overflow = 'auto';
}

// 计算距离
function getDistance(lat1,lng1,lat2,lng2){
  const R=6371000,dLat=(lat2-lat1)*Math.PI/180,dLng=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

// 地址更新
function updateAddress(lat,lng){
  const now=Date.now();
  if(now-lastAddressTime<10000) return;
  if(lastLatLng){
    const dist=getDistance(lat,lng,lastLatLng.lat,lastLatLng.lng);
    if(dist<10) return;
  }
  lastAddressTime=now;
  lastLatLng={lat,lng};
  fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`)
    .then(res=>res.json())
    .then(data=>{
      document.getElementById('address').innerHTML=`<i class="fa-solid fa-house"></i> 地址: ${data.display_name||"未获取到"}`;
    })
    .catch(()=>{document.getElementById('address').innerHTML=`<i class="fa-solid fa-house"></i> 地址获取失败`;});
}

// 信息更新
function updateOutput(lat,lng,gpsAlt,acc,speed,heading,timestamp){
  fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`)
    .then(res=>res.json())
    .then(data=>{
      const ground=data.results[0].elevation;
      const relHeight=gpsAlt!=null?gpsAlt-ground:0;
      document.getElementById('output').innerHTML=
`<i class="fa-solid fa-location-dot"></i> 纬度: ${lat}<br>
<i class="fa-solid fa-location-dot"></i> 经度: ${lng}<br>
<i class="fa-solid fa-bullseye"></i> 精度: ±${acc} 米<br>
<i class="fa-solid fa-mountain"></i> 海拔高度: ${gpsAlt!=null?gpsAlt.toFixed(1):"—"} m<br>
<i class="fa-solid fa-earth-asia"></i> 相对地面高度: ${relHeight.toFixed(1)} m<br>
<i class="fa-solid fa-car"></i> 速度: ${speed}<br>
<i class="fa-solid fa-compass"></i> 航向: ${heading}<br>
<i class="fa-regular fa-clock"></i> 时间: ${new Date(timestamp).toLocaleTimeString()}`;
    })
    .catch(()=>{
      document.getElementById('output').innerHTML=
`<i class="fa-solid fa-location-dot"></i> 纬度: ${lat}<br>
<i class="fa-solid fa-location-dot"></i> 经度: ${lng}<br>
<i class="fa-solid fa-bullseye"></i> 精度: ±${acc} 米<br>
<i class="fa-solid fa-mountain"></i> 海拔高度: ${gpsAlt!=null?gpsAlt.toFixed(1):"—"} m<br>
<i class="fa-solid fa-earth-asia"></i> 相对地面高度: — m<br>
<i class="fa-solid fa-car"></i> 速度: ${speed}<br>
<i class="fa-solid fa-compass"></i> 航向: ${heading}<br>
<i class="fa-regular fa-clock"></i> 时间: ${new Date(timestamp).toLocaleTimeString()}`;
    });
}

// 定位函数
function locateOnce(){
  if(!navigator.geolocation){ showModal("❌ 当前浏览器不支持定位"); return; }
  navigator.geolocation.getCurrentPosition(
    pos=>{
      const c=pos.coords;
      const lat=parseFloat(c.latitude).toFixed(6);
      const lng=parseFloat(c.longitude).toFixed(6);
      const acc=c.accuracy?.toFixed(1);
      const alt=c.altitude!=null?c.altitude:0;
      const speed=c.speed!=null?(c.speed*3.6).toFixed(1)+" km/h":"—";
      const heading=c.heading!=null?c.heading.toFixed(1)+"°":"—";
      lastCoords={lat,lng,altitude:alt,accuracy:acc,speed,heading,timestamp:pos.timestamp};

      if(marker){ marker.setLatLng([lat,lng]); }
      else{ marker=L.marker([lat,lng]).addTo(map).bindPopup("你在这里").openPopup(); }
      map.setView([lat,lng],16);

      updateOutput(lat,lng,alt,acc,speed,heading,pos.timestamp);
      updateAddress(lat,lng);
    },
    err=>{ showModal("❌ 定位失败: "+err.message); },
    { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
  );
}

// 打开地图函数
function openGoogleMap() {
  if (!lastCoords) { showModal("⚠️ 请先获取定位！"); return; }
  window.open(`https://maps.google.com/?q=${lastCoords.lat},${lastCoords.lng}`, "_blank");
}
function openAppleMap() {
  if (!lastCoords) { showModal("⚠️ 请先获取定位！"); return; }
  window.open(`http://maps.apple.com/?ll=${lastCoords.lat},${lastCoords.lng}`, "_blank");
}
function openAmap() {
  if (!lastCoords) { showModal("⚠️ 请先获取定位！"); return; }
  window.open(`https://uri.amap.com/marker?position=${lastCoords.lng},${lastCoords.lat}`, "_blank");
}
function openTencentMap() {
  if (!lastCoords) { showModal("⚠️ 请先获取定位！"); return; }
  window.open(`https://map.qq.com/?type=marker&isopeninfowin=1&markertype=1&lat=${lastCoords.lat}&lng=${lastCoords.lng}`, "_blank");
}
function openBaiduMap() {
  if (!lastCoords) { showModal("⚠️ 请先获取定位！"); return; }
  window.open(`https://api.map.baidu.com/marker?location=${lastCoords.lat},${lastCoords.lng}&title=我的位置&output=html`, "_blank");
}

// 页面加载立即定位，并每分钟更新一次
locateOnce();
setInterval(locateOnce, 60000);
</script>

</body>
</html>