<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å®šä½</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, Arial; margin:0; padding:0; }
#controls { padding: 10px; text-align: center; }
button { padding: 10px 16px; margin: 5px; border: none; border-radius: 6px; font-size: 14px; }
.start { background: #28a745; color: #fff; }
.stop { background: #dc3545; color: #fff; }
.mapbtn { background: #007bff; color: #fff; }
#output, #address { padding: 10px; font-size: 14px; white-space: pre-line; }
#address { color: #007bff; }
#map { height: 400px; width: 100%; }
</style>
</head>
<body>
<div id="controls">
<button class="start" onclick="startTracking()">å¼€å§‹è¿½è¸ª</button>
<button class="stop" onclick="stopTracking()">åœæ­¢è¿½è¸ª</button>
<button class="mapbtn" onclick="openInMap()">åœ¨åœ°å›¾ä¸­æ‰“å¼€</button>
</div>

<div id="output">ç­‰å¾…æ“ä½œ...</div>
<div id="address">ğŸ  åœ°å€: æœªè·å–</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let watchId = null;
let lastCoords = null;
let lastAddressTime = 0;
let map, marker;
let firstLocate = true;
let lastLatLng = null;

// åˆå§‹åŒ–åœ°å›¾
map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

function getDistance(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// åœ°å€æ¯10ç§’æˆ–ç§»åŠ¨â‰¥10mæ›´æ–°
function updateAddress(lat, lng) {
  const now = Date.now();
  if (now - lastAddressTime < 10000) return;
  if (lastLatLng) {
    const dist = getDistance(lat, lng, lastLatLng.lat, lastLatLng.lng);
    if (dist < 10) return;
  }
  lastAddressTime = now;
  lastLatLng = { lat, lng };

  fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById('address').innerText = `ğŸ  åœ°å€: ${data.display_name || "æœªè·å–åˆ°"}`;
    })
    .catch(() => {
      document.getElementById('address').innerText = "ğŸ  åœ°å€è·å–å¤±è´¥";
    });
}

// åœ°é¢é«˜åº¦
function updateHeight(lat, lng, gpsAlt) {
  fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`)
    .then(res => res.json())
    .then(data => {
      const ground = data.results[0].elevation;
      const relHeight = gpsAlt != null ? gpsAlt - ground : 0;
      document.getElementById('output').innerText = 
`ğŸ“ çº¬åº¦: ${lat}
ğŸ“ ç»åº¦: ${lng}
ğŸ¯ ç²¾åº¦: Â±${lastCoords.accuracy} ç±³
â›°ï¸ æµ·æ‹”é«˜åº¦: ${gpsAlt != null ? gpsAlt.toFixed(1) : "â€”"} m
ğŸŒ ç›¸å¯¹åœ°é¢é«˜åº¦: ${relHeight.toFixed(1)} m
ğŸš— é€Ÿåº¦: ${lastCoords.speed || "â€”"} 
ğŸ§­ èˆªå‘: ${lastCoords.heading || "â€”"}
â±ï¸ æ—¶é—´: ${new Date(lastCoords.timestamp).toLocaleTimeString()}`;
    })
    .catch(() => {
      document.getElementById('output').innerText = 
`ğŸ“ çº¬åº¦: ${lat}
ğŸ“ ç»åº¦: ${lng}
ğŸ¯ ç²¾åº¦: Â±${lastCoords.accuracy} ç±³
â›°ï¸ æµ·æ‹”é«˜åº¦: ${gpsAlt != null ? gpsAlt.toFixed(1) : "â€”"} m
ğŸŒ ç›¸å¯¹åœ°é¢é«˜åº¦: â€” m
ğŸš— é€Ÿåº¦: ${lastCoords.speed || "â€”"} 
ğŸ§­ èˆªå‘: ${lastCoords.heading || "â€”"}
â±ï¸ æ—¶é—´: ${new Date(lastCoords.timestamp).toLocaleTimeString()}`;
    });
}

function startTracking() {
  if (!navigator.geolocation) {
    document.getElementById('output').innerText = "âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå®šä½";
    return;
  }

  document.getElementById('output').innerText = "â³ æ­£åœ¨è¿½è¸ªä½ç½®...";

  watchId = navigator.geolocation.watchPosition(
    pos => {
      const c = pos.coords;
      const lat = parseFloat(c.latitude).toFixed(6);
      const lng = parseFloat(c.longitude).toFixed(6);
      const acc = c.accuracy?.toFixed(1);
      const alt = c.altitude != null ? c.altitude : 0;
      const speed = c.speed != null ? (c.speed * 3.6).toFixed(1) + " km/h" : "â€”";
      const heading = c.heading != null ? c.heading.toFixed(1) + "Â°" : "â€”";

      lastCoords = { lat, lng, altitude: alt, accuracy: acc, speed, heading, timestamp: pos.timestamp };

      const latNum = parseFloat(lat);
      const lngNum = parseFloat(lng);

      if (marker) {
        marker.setLatLng([latNum, lngNum]);
      } else {
        marker = L.marker([latNum, lngNum]).addTo(map).bindPopup("ä½ åœ¨è¿™é‡Œ").openPopup();
      }

      if (firstLocate) {
        map.setView([latNum, lngNum], 16); 
        firstLocate = false;
      } else {
        map.setView([latNum, lngNum], map.getZoom());
      }

      // å®æ—¶åˆ·æ–°é«˜åº¦å’Œç»çº¬åº¦ä¿¡æ¯
      updateHeight(latNum, lngNum, alt);

      // åœ°å€æŒ‰åŸè§„åˆ™æ›´æ–°
      updateAddress(latNum, lngNum);

    },
    err => {
      document.getElementById('output').innerText = "âŒ å®šä½å¤±è´¥: " + err.message;
    },
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

function stopTracking() {
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    document.getElementById('output').innerText = "âœ… å·²åœæ­¢è¿½è¸ª";
    document.getElementById('address').innerText = "ğŸ  åœ°å€: æœªè·å–";
  }
}

function openInMap() {
  if (!lastCoords) {
    alert("è¯·å…ˆè·å–å®šä½ï¼");
    return;
  }
  const { lat, lng } = lastCoords;
  window.open(`https://maps.google.com/?q=${lat},${lng}`, "_blank");
}
</script>
</body>
</html>