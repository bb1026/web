<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>èº«ä»½è¯å·ç éªŒè¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 20px;
      background: #f2f2f2;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: #fff;
      padding: 30px 25px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    }

    input[type="text"] {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border: 2px solid transparent;
      border-radius: 24px;
      background: linear-gradient(white, white) padding-box,
                  linear-gradient(135deg, #ff6ec4, #7873f5) border-box;
      transition: box-shadow 0.3s ease, border-color 0.3s ease;
      outline: none;
      box-sizing: border-box;
    }

    input[type="text"]:focus {
      box-shadow: 0 0 10px rgba(255, 110, 196, 0.5);
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 24px;
      cursor: pointer;
      background: linear-gradient(135deg, #42a5f5, #478ed1);
      color: white;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(66, 165, 245, 0.4);
    }

    .result {
      margin-top: 25px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      font-size: 15px;
      color: #333;
      box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.05);
      line-height: 1.8;
    }

    .success {
      color: green;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .error {
      color: red;
      font-weight: bold;
      padding: 10px 0;
    }

    #qrcode {
      margin-top: 20px;
      text-align: center;
    }

    canvas {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>èº«ä»½è¯å·ç éªŒè¯</h1>
    <input type="text" id="idInput" placeholder="è¯·è¾“å…¥18ä½èº«ä»½è¯å·ç " />
    <button id="validateBtn" onclick="validateID()">éªŒè¯</button>
    <div class="result" id="result"></div>
    <div id="qrcode"></div>
  </div>

  <!-- å¼•å…¥äºŒç»´ç åº“ï¼ˆqrcode.min.jsï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script>
  document.getElementById("idInput").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      validateID();
    }
  });

  function isValidChecksum(id) {
    const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
    const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
    let sum = 0;
    for (let i = 0; i < 17; i++) {
      sum += parseInt(id[i]) * weights[i];
    }
    const code = checkCodes[sum % 11];
    return code === id[17].toUpperCase();
  }

  let validating = false;

async function validateID() {
  if (validating) return; // ğŸš« é˜²æ­¢é‡å¤æ‰§è¡Œ
  validating = true;

  const btn = document.getElementById("validateBtn");
  btn.disabled = true;
  const id = document.getElementById("idInput").value.trim();
  const resultDiv = document.getElementById("result");
  const qrDiv = document.getElementById("qrcode");
  qrDiv.innerHTML = ''; // æ¸…ç©ºäºŒç»´ç 

  let region = "æœªçŸ¥åœ°åŒº";
  try {
    const res = await fetch(`/json/region.json?timestamp=${Date.now()}`);
    const data = await res.json();
    const code = id.substring(0, 6);
    region = data[code] || "æœªçŸ¥åœ°åŒº";
  } catch (e) {
    region = "ï¼ˆåœ°åŒºä¿¡æ¯è·å–å¤±è´¥ï¼‰";
  }

  // æ ¡éªŒæ ¼å¼
  if (!/^\d{17}[\dXx]$/.test(id)) {
    resultDiv.innerHTML = `
      <div class="error">âŒ æ— æ•ˆçš„èº«ä»½è¯å·ç æ ¼å¼</div>
      <strong>åœ°åŒºï¼š</strong>${region}
    `;
    return;
  }

  // æ ¡éªŒæ ¡éªŒç 
  if (!isValidChecksum(id)) {
    resultDiv.innerHTML = `
      <div class="error">âŒ æ ¡éªŒç é”™è¯¯ï¼šèº«ä»½è¯å·ç ä¸åˆæ³•</div>
      <strong>åœ°åŒºï¼š</strong>${region}
    `;
    return;
  }

  // èº«ä»½è¯åˆæ³•ï¼Œæ­£å¸¸æ˜¾ç¤ºä¿¡æ¯
  const birth = id.substring(6, 14);
  const year = birth.substring(0, 4);
  const month = birth.substring(4, 6);
  const day = birth.substring(6, 8);

  const now = new Date();
  let age = now.getFullYear() - parseInt(year);
  if (parseInt(month) > now.getMonth() + 1 ||
      (parseInt(month) === now.getMonth() + 1 && parseInt(day) > now.getDate())) {
    age--;
  }

  const zodiac = ["çŒ´", "é¸¡", "ç‹—", "çŒª", "é¼ ", "ç‰›", "è™", "å…”", "é¾™", "è›‡", "é©¬", "ç¾Š"][parseInt(year) % 12];
  const gender = parseInt(id.charAt(16)) % 2 === 1 ? "ç”·" : "å¥³";

  const summary = 
    `èº«ä»½è¯å·ç ï¼š${id}\n` +
    `å‡ºç”Ÿæ—¥æœŸï¼š${year}å¹´${month}æœˆ${day}æ—¥\n` +
    `å¹´é¾„ï¼š${age}å²\n` +
    `æ€§åˆ«ï¼š${gender}\n` +
    `ç”Ÿè‚–ï¼š${zodiac}\n` +
    `åœ°åŒºï¼š${region}`;

  resultDiv.innerHTML = `
    <div class="success">âœ… èº«ä»½è¯å·ç éªŒè¯æˆåŠŸ</div>
    <strong>å‡ºç”Ÿæ—¥æœŸï¼š</strong>${year}å¹´${month}æœˆ${day}æ—¥<br>
    <strong>å¹´é¾„ï¼š</strong>${age} å²<br>
    <strong>æ€§åˆ«ï¼š</strong>${gender}<br>
    <strong>ç”Ÿè‚–ï¼š</strong>${zodiac}<br>
    <strong>åœ°åŒºï¼š</strong>${region}
  `;

  // ç”ŸæˆäºŒç»´ç 
qrDiv.innerHTML = '';
document.getElementById("saveQRBtn").style.display = "none";

QRCode.toString(summary, {
  type: 'svg',
  width: 220,
  margin: 1,
  color: {
    dark: '#1e88e5',   // äºŒç»´ç é¢œè‰²ï¼ˆå¯æ”¹ï¼‰
    light: '#ffffff'  // èƒŒæ™¯è‰²
  }
}, function (err, svg) {
  if (err) return;

  // ğŸŒˆ æ’å…¥æ¸å˜ï¼ˆå¯é€‰ï¼Œæƒ³è¦é«˜çº§å°±ç•™ç€ï¼‰
  svg = svg.replace(
    '<svg',
    `<svg>
      <defs>
        <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%"/>
          <stop offset="100%"/>
        </linearGradient>
      </defs>`
  );

  qrDiv.innerHTML = svg;

  // ä¿å­˜æŒ‰é’®æ˜¾ç¤º
  document.getElementById("saveQRBtn").style.display = "block";

  // ä¿å­˜ SVG
  document.getElementById("saveQRBtn").onclick = function () {
    const blob = new Blob([svg], { type: "image/svg+xml" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "èº«ä»½è¯äºŒç»´ç .svg";
    a.click();

    URL.revokeObjectURL(url);
  };
});});
  }
</script>
</body>
</html>