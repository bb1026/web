<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>农历查询 & ICS生成</title>
<!-- 引入 Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  body { 
    font-family: "微软雅黑", sans-serif; 
    padding: 0.5em; 
    max-width: 800px; 
    margin: auto; 
    background: #f0f4f8; 
    color: #333;
  }
  h1 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 0.5em;
    border-bottom: 2px solid #3498db;
  }
  h2 { 
    color: #3498db; 
    margin-top: 0.3em;
    border-bottom: 1px solid #ddd;
  }
  input, button { 
    font-size: 0.9em;
    padding: 0.5em 0.8em; 
    margin: 0.3em; 
    border-radius: 6px; 
    border: 1px solid #ccc; 
    box-sizing: border-box;
  }
  input[type="date"], input[type="number"] {
    width: 180px;
  }
  button { 
    background: #3498db; 
    color: white; 
    cursor: pointer;
    border: none;
    transition: background 0.3s;
  }
  button:hover { 
    background: #2980b9; 
  }
  pre { 
    background: #fff; 
    padding: 1em; 
    overflow-x: auto; 
    border: 1px solid #ddd; 
    border-radius: 6px; 
  }
  label { 
    margin-right: 1em; 
    display: inline-block;
    margin-bottom: 0.5em;
  }
  .section { 
    margin-bottom: 2em; 
    background: white;
    padding: 1.5em;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  }
  .status {
    padding: 0.8em;
    margin: 1em 0;
    border-radius: 6px;
    background: #eaf7ff;
    border-left: 4px solid #3498db;
  }
  .event-list {
    margin: 1em 0;
    padding: 0;
    list-style-type: none;
  }
  .event-list li {
    padding: 0.7em;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .event-list li:nth-child(odd) {
    background: #f9f9f9;
  }
  .event-info {
    flex-grow: 1;
  }
  .event-date {
    font-weight: bold;
    margin-right: 10px;
    color: #2c3e50;
  }
  .event-name {
    color: #3498db;
  }
  .delete-btn {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 0.4em 0.8em;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.85em;
  }
  .delete-btn:hover {
    background: #c0392b;
  }
  .filter-group {
    margin: 1em 0;
    padding: 0.8em;
    background: #f0f8ff;
    border-radius: 6px;
  }
  #downloadICS {
    background: #27ae60;
    padding: 0.6em 1em;
    font-weight: bold;
    margin-top: 1em;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.9em;
  }
  #downloadICS:hover {
    background: #219653;
  }
  .clear-all {
    background: #e67e22;
    margin-left: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.85em;
    padding: 0.4em 0.8em;
  }
  .clear-all:hover {
    background: #d35400;
  }
  .date-input {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5em;
  }
  .date-buttons {
    display: flex;
    gap: 0.5em;
  }
  .date-buttons button {
    flex: 1;
  }
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 16px;
    background: #2ecc71;
    color: white;
    border-radius: 6px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    opacity: 0;
    transform: translateX(100px);
    transition: all 0.3s ease;
    font-size: 0.9em;
  }
  .notification.error {
    background: #e74c3c;
  }
  .notification.show {
    opacity: 1;
    transform: translateX(0);
  }
</style>
</head>
<body>
<h1><i class="fa-solid fa-calendar-days"></i> 农历查询 & ICS生成</h1>

<div class="section">
  <h2><i class="fa-solid fa-calendar"></i> 查询日期信息</h2>
  <div class="date-input">
    <input type="date" id="dateInput">
    <div class="date-buttons">
      <button id="prevDay"><i class="fa-solid fa-arrow-left"></i> 前一天</button>
      <button id="nextDay">后一天 <i class="fa-solid fa-arrow-right"></i></button>
    </div>
  </div>
  <pre id="dateResult"></pre>
  <button id="addDateICS"><i class="fa-solid fa-plus"></i> 添加到 ICS</button>
</div>

<div class="section">
  <h2><i class="fa-solid fa-calendar-check"></i> 生成整年节日ICS</h2>
  <p>
    <i class="fa-solid fa-hashtag"></i> 年份: <input type="number" id="yearInput" min="1900" max="2100" step="1">
  </p>
  <div class="filter-group">
    <label><input type="checkbox" class="filter" value="节气" checked> <i class="fa-solid fa-sun"></i> 节气</label>
    <label><input type="checkbox" class="filter" value="农历节日" checked> <i class="fa-solid fa-moon"></i> 农历节日</label>
    <label><input type="checkbox" class="filter" value="阳历节日" checked> <i class="fa-solid fa-star"></i> 阳历节日</label>
  </div>
  <button id="generateYearICS"><i class="fa-solid fa-file-import"></i> 生成整年ICS</button>
  <div id="yearStatus" class="status"></div>
</div>

<div class="section">
  <h2><i class="fa-solid fa-list"></i> ICS事件列表 <button id="clearAll" class="clear-all"><i class="fa-solid fa-trash"></i> 清空所有</button></h2>
  <div id="icsCount" class="status">当前有 0 个事件</div>
  <ul id="icsList" class="event-list"></ul>
  <button id="downloadICS"><i class="fa-solid fa-download"></i> 下载 ICS 文件</button>
</div>

<script>
let dateInfo = null;
let yearEvents = [];
let icsEvents = []; // 当前 ICS 保存的事件列表

// 显示通知
function showNotification(message, isError = false) {
  const notification = document.createElement('div');
  notification.className = isError ? 'notification error' : 'notification';
  notification.textContent = message;
  document.body.appendChild(notification);
  
  // 显示通知
  setTimeout(() => notification.classList.add('show'), 10);
  
  // 3秒后隐藏并移除通知
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => document.body.removeChild(notification), 300);
  }, 3000);
}

// 检查事件是否已存在
function isEventExists(newEvent) {
  return icsEvents.some(event => 
    event.date === newEvent.date && event.name === newEvent.name
  );
}

async function loadLunarCalendar() {
  const url = "../js/lunarCalendar.js";
  try {
    const res = await fetch(url);
    const jsCode = await res.text();
    eval(jsCode);
    init();
  } catch (error) {
    console.error("加载农历日历失败:", error);
    showNotification("加载农历日历失败，请检查网络连接", true);
  }
}

function init() {
  if (!window.LunarCalendar) {
    showNotification("LunarCalendar 加载失败！", true);
    return console.error("LunarCalendar 加载失败！");
  }

  const today = new Date();
  const dateInput = document.getElementById("dateInput");
  dateInput.value = today.toISOString().slice(0,10);
  dateInfo = showDateInfo(today.toISOString().slice(0,10));
  document.getElementById("yearInput").value = today.getFullYear();

  // 日期选择自动查询
  dateInput.addEventListener("change", () => {
    const dateStr = dateInput.value;
    if(!dateStr) return;
    dateInfo = showDateInfo(dateStr);
  });

  // 前一天按钮
  document.getElementById("prevDay").addEventListener("click", () => {
    const currentDate = new Date(dateInput.value);
    currentDate.setDate(currentDate.getDate() - 1);
    dateInput.value = currentDate.toISOString().slice(0,10);
    dateInfo = showDateInfo(dateInput.value);
  });

  // 后一天按钮
  document.getElementById("nextDay").addEventListener("click", () => {
    const currentDate = new Date(dateInput.value);
    currentDate.setDate(currentDate.getDate() + 1);
    dateInput.value = currentDate.toISOString().slice(0,10);
    dateInfo = showDateInfo(dateInput.value);
  });

  // 单日添加到 ICS
  document.getElementById("addDateICS").addEventListener("click", () => {
    if(!dateInfo) {
      showNotification("请先选择日期！", true);
      return;
    }
    
    const events = [];
    // 添加节日和节气
    if(dateInfo.solarFestival) events.push({date: dateInfo.date, name: dateInfo.solarFestival});
    if(dateInfo.lunarFestival) events.push({date: dateInfo.date, name: dateInfo.lunarFestival});
    if(dateInfo.solarTerm) events.push({date: dateInfo.date, name: dateInfo.solarTerm});
    
    if(events.length === 0) {
      showNotification("该日期没有节日或节气信息！", true);
      return;
    }
    
    // 过滤掉已存在的事件
    const newEvents = events.filter(event => !isEventExists(event));
    
    if (newEvents.length === 0) {
      showNotification("所有事件都已存在于ICS列表中！");
      return;
    }
    
    icsEvents.push(...newEvents);
    updateIcsList();
    showNotification(`已添加 ${newEvents.length} 个新事件到 ICS！`);
  });

  // 生成整年ICS事件
  document.getElementById("generateYearICS").addEventListener("click", () => {
    const year = parseInt(document.getElementById("yearInput").value);
    if(isNaN(year) || year < 1900 || year > 2100) {
      showNotification("请输入有效的年份（1900-2100）", true);
      return;
    }
    
    const checked = Array.from(document.querySelectorAll(".filter:checked")).map(c => c.value);
    const allFestivals = LunarCalendar.getYearFestivalsAndTerms(year);
    yearEvents = allFestivals.filter(f => checked.includes(f.type));
    
    // 过滤掉已存在的事件
    const newEvents = yearEvents
      .map(f => ({date: f.date, name: f.name}))
      .filter(event => !isEventExists(event));
    
    if (newEvents.length === 0) {
      showNotification("所有年份事件都已存在于ICS列表中！");
      return;
    }
    
    icsEvents.push(...newEvents);
    updateIcsList();
    
    const statusDiv = document.getElementById("yearStatus");
    statusDiv.textContent = `已添加 ${newEvents.length} 个新事件到ICS列表`;
    showNotification(`已添加 ${newEvents.length} 个年份事件到 ICS！`);
  });

  // 下载 ICS
  document.getElementById("downloadICS").addEventListener("click", () => {
    if(icsEvents.length === 0) {
      showNotification("当前没有 ICS 事件！", true);
      return;
    }
    const icsContent = generateICS(icsEvents);
    downloadICS("festival_calendar.ics", icsContent);
    showNotification("ICS文件已开始下载！");
  });

  // 清空所有事件
  document.getElementById("clearAll").addEventListener("click", () => {
    if(icsEvents.length === 0) {
      showNotification("ICS列表已经是空的！");
      return;
    }
    
    if(confirm("确定要清空所有事件吗？")) {
      icsEvents = [];
      updateIcsList();
      showNotification("已清空所有事件！");
    }
  });
}

// 显示单日信息
function showDateInfo(dateStr){
  const d = new Date(dateStr);
  const info = LunarCalendar.getDayInfo(d.getFullYear(), d.getMonth()+1, d.getDate());
  document.getElementById("dateResult").textContent = JSON.stringify(info, null, 2);
  return info;
}

// 更新ICS事件列表显示
function updateIcsList() {
  const list = document.getElementById("icsList");
  const count = document.getElementById("icsCount");
  
  list.innerHTML = "";
  count.textContent = `当前有 ${icsEvents.length} 个事件`;
  
  icsEvents.forEach((event, index) => {
    const li = document.createElement("li");
    
    const eventInfo = document.createElement("div");
    eventInfo.className = "event-info";
    eventInfo.innerHTML = `<span class="event-date">${event.date}</span><span class="event-name">${event.name}</span>`;
    
    const deleteBtn = document.createElement("button");
    deleteBtn.className = "delete-btn";
    deleteBtn.textContent = "删除";
    deleteBtn.onclick = () => {
      icsEvents.splice(index, 1);
      updateIcsList();
      showNotification("已删除事件");
    };
    
    li.appendChild(eventInfo);
    li.appendChild(deleteBtn);
    list.appendChild(li);
  });
}

// 生成 ICS 字符串
function generateICS(events){
  // 获取当前时间作为DTSTAMP
  const now = new Date();
  const dtstamp = now.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
  
  let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nCALSCALE:GREGORIAN\nPRODID:-//Festival Calendar Generator//CN\n";
  
  events.forEach(ev => {
    const startDate = new Date(ev.date);
    const start = startDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    const endDate = new Date(startDate.getTime() + 24 * 60 * 60 * 1000 - 1000); // 结束时间为当天23:59:59
    const end = endDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    
    // 生成UID
    const uid = `${ev.name.toLowerCase().replace(/\s+/g, '')}@0515364.xyz`;
    
    ics += "BEGIN:VEVENT\n";
    ics += `UID:${uid}\n`;
    ics += `DTSTAMP:${dtstamp}\n`;
    ics += `SUMMARY:${ev.name}\n`;
    ics += `DTSTART:${start}\n`;
    ics += `DTEND:${end}\n`;
    ics += "END:VEVENT\n";
  });
  
  ics += "END:VCALENDAR";
  return ics;
}

// 下载 ICS
function downloadICS(filename, content){
  const blob = new Blob([content], {type: "text/calendar;charset=utf-8"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

loadLunarCalendar();
</script>
</body>
</html>